{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2021-051.pdf"
  },
  "title": "Critical Vulnerabilities in Azure OMI Agents",
  "serial_number": "2021-051",
  "publish_date": "15-09-2021 11:59:00",
  "description": "On 14th of September 2021, Microsoft released information about four vulnerabilities that affects Open Management Infrastructure (OMI) agent.<br>One vulnerability - CVE-2021-38647 - is critical with CVSSv3 Score 9.8. If the HTTP/S port listening to OMI is exposed, it could allow remote code execution by sending a specially-crafted message from remote.<br>The other three vulnerabilities - CVE-2021-38645, CVE-2021-38648 and CVE-2021-38649 - are related to privilege escalation that enables attackers to gain the \"root\" privileges on a machine with OMI installed.<br>The OMI agent is automatically deployed by certain Azure services. These parent services should handle the upgrade of the agents, however this has to be double checked. CERT-EU recommends to perform the upgrade as soon as possible.",
  "url_title": "2021-051",
  "content_markdown": "---\ntitle: 'Critical Vulnerabilities in Azure OMI Agents'\nversion: '1.0'\nnumber: '2021-051'\ndate: 'September 15, 2021'\n---\n\n_History:_\n\n* _15/09/2021 --- v1.0 -- Initial publication_\n\n# Summary\n\nOn 14th of September 2021, Microsoft released information about four vulnerabilities that affects Open Management Infrastructure (OMI) agent.\n\nOne vulnerability -- CVE-2021-38647 [1] -- is critical with CVSSv3 Score 9.8. If the HTTP/S port listening to OMI is exposed, it could allow remote code execution by sending a specially-crafted message from remote.\n\nThe other three vulnerabilities -- CVE-2021-38645 [2], CVE-2021-38648 [3] and CVE-2021-38649 [4] -- are related to privilege escalation that enables attackers to gain the `root` privileges on a machine with OMI installed.\n\nThe OMI agent is automatically deployed by certain Azure services. These parent services should handle the upgrade of the agents, however this has to be double checked. CERT-EU recommends to perform the upgrade as soon as possible.\n\n# Technical Details\n\n**CVE-2021-38647 [1] - OMI Remote Code Execution Vulnerability**\n\nSome Azure products, such as Azure Configuration Management or System Center Operations Manager (SCOM), expose an HTTP/S port listening to OMI requests. The configuration where the HTTP/S listener is enabled could allow remote code execution. It is important to mention that most Azure services that use OMI, deploy it without exposing the HTTP/S port. According to [6], any request without an authorization header has its privileges default to `uid=0`, `gid=0`, which is `root`.\n\n**CVE-2021-38645 [2], CVE-2021-38648 [3] and CVE-2021-38649[4] - OMI Elevation of Privilege Vulnerability**\n\nNo technical details have been shared related to these vulnerabilities.\n\n# Products Affected\n\nOMI agents version less than v1.6.8-1.\n\nAccording to [6], the Linux machines built in Azure are at risk if they use any of the following services / tools:\n\n- Azure Automation,\n- Azure Automatic Update,\n- Azure Operations Management Suite (OMS),\n- Azure Log Analytics, Azure Configuration Management,\n- Azure Diagnostics.\n\nIn addition to Azure cloud, also the on-premise Linux machines with OMI installed as part of System Center (Microsoft’s server management solution) for example, are also at risk.  \n\n# Recommendations\n\nCheck if the OMI agent has the latest version as released in [5]. This can be done from Azure VMs by running the following commands in your terminal:\n\n- for Debian systems (e.g., Ubuntu): `dpkg -l omi`\n- for Redhat based system (e.g., Fedora, CentOS, RHEL): `rpm -qa omi`\n\nIf OMI is not installed, no results will be returned.\n\nAccording to the security advisory [1], if the agent was not automatically installed, then the following steps should be taken:\n\n- Add the MSRepo to your system. Based on the Linux OS that you are using, refer to this link [7] to install the MSRepo to your system.\n- After that, use your platform's package tool to upgrade OMI (for example, `sudo apt-get install omi` or `sudo yum install omi`).\n\nFor more information refer to [8].\n\n## Workarounds and Mitigations\n\nFor CVE-2021-38647, check if you have the OMI listening ports open and limit access to them. For different services the port number could be different. On most Linux distributions, the command `netstat -an | grep <port-number>` will indicate if any processes are listening on `<port-number>`.\n\n# References\n\n[1] <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647>\n\n[2] <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38645>\n\n[3] <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38648>\n\n[4] <https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38649>\n\n[5] <https://github.com/microsoft/omi-kits/tree/master/release>\n\n[6] <https://www.wiz.io/blog/secret-agent-exposes-azure-customers-to-unauthorized-code-execution>\n\n[7] <https://docs.microsoft.com/en-us/windows-server/administration/Linux-Package-Repository-for-Microsoft-Software>\n\n[8] <https://github.com/microsoft/omi#get-omi>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>15/09/2021 --- v1.0 -- Initial publication</em></li></ul><h2 id=\"summary\">Summary</h2><p>On 14th of September 2021, Microsoft released information about four vulnerabilities that affects Open Management Infrastructure (OMI) agent.</p><p>One vulnerability -- CVE-2021-38647 [1] -- is critical with CVSSv3 Score 9.8. If the HTTP/S port listening to OMI is exposed, it could allow remote code execution by sending a specially-crafted message from remote.</p><p>The other three vulnerabilities -- CVE-2021-38645 [2], CVE-2021-38648 [3] and CVE-2021-38649 [4] -- are related to privilege escalation that enables attackers to gain the <code>root</code> privileges on a machine with OMI installed.</p><p>The OMI agent is automatically deployed by certain Azure services. These parent services should handle the upgrade of the agents, however this has to be double checked. CERT-EU recommends to perform the upgrade as soon as possible.</p><h2 id=\"technical-details\">Technical Details</h2><p><strong>CVE-2021-38647 [1] - OMI Remote Code Execution Vulnerability</strong></p><p>Some Azure products, such as Azure Configuration Management or System Center Operations Manager (SCOM), expose an HTTP/S port listening to OMI requests. The configuration where the HTTP/S listener is enabled could allow remote code execution. It is important to mention that most Azure services that use OMI, deploy it without exposing the HTTP/S port. According to [6], any request without an authorization header has its privileges default to <code>uid=0</code>, <code>gid=0</code>, which is <code>root</code>.</p><p><strong>CVE-2021-38645 [2], CVE-2021-38648 [3] and CVE-2021-38649[4] - OMI Elevation of Privilege Vulnerability</strong></p><p>No technical details have been shared related to these vulnerabilities.</p><h2 id=\"products-affected\">Products Affected</h2><p>OMI agents version less than v1.6.8-1.</p><p>According to [6], the Linux machines built in Azure are at risk if they use any of the following services / tools:</p><ul><li>Azure Automation,</li><li>Azure Automatic Update,</li><li>Azure Operations Management Suite (OMS),</li><li>Azure Log Analytics, Azure Configuration Management,</li><li>Azure Diagnostics.</li></ul><p>In addition to Azure cloud, also the on-premise Linux machines with OMI installed as part of System Center (Microsoft’s server management solution) for example, are also at risk. </p><h2 id=\"recommendations\">Recommendations</h2><p>Check if the OMI agent has the latest version as released in [5]. This can be done from Azure VMs by running the following commands in your terminal:</p><ul><li>for Debian systems (e.g., Ubuntu): <code>dpkg -l omi</code></li><li>for Redhat based system (e.g., Fedora, CentOS, RHEL): <code>rpm -qa omi</code></li></ul><p>If OMI is not installed, no results will be returned.</p><p>According to the security advisory [1], if the agent was not automatically installed, then the following steps should be taken:</p><ul><li>Add the MSRepo to your system. Based on the Linux OS that you are using, refer to this link [7] to install the MSRepo to your system.</li><li>After that, use your platform's package tool to upgrade OMI (for example, <code>sudo apt-get install omi</code> or <code>sudo yum install omi</code>).</li></ul><p>For more information refer to [8].</p><h3 id=\"workarounds-and-mitigations\">Workarounds and Mitigations</h3><p>For CVE-2021-38647, check if you have the OMI listening ports open and limit access to them. For different services the port number could be different. On most Linux distributions, the command <code>netstat -an | grep &lt;port-number&gt;</code> will indicate if any processes are listening on <code>&lt;port-number&gt;</code>.</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38645\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38645</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38648\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38648</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38649\">https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38649</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/microsoft/omi-kits/tree/master/release\">https://github.com/microsoft/omi-kits/tree/master/release</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.wiz.io/blog/secret-agent-exposes-azure-customers-to-unauthorized-code-execution\">https://www.wiz.io/blog/secret-agent-exposes-azure-customers-to-unauthorized-code-execution</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/windows-server/administration/Linux-Package-Repository-for-Microsoft-Software\">https://docs.microsoft.com/en-us/windows-server/administration/Linux-Package-Repository-for-Microsoft-Software</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/microsoft/omi#get-omi\">https://github.com/microsoft/omi#get-omi</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  }
}