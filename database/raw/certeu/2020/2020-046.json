{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2020-046.pdf"
  },
  "title": "UPDATE: Zerologon Critical Vulnerability Affecting Windows Domain Controllers",
  "serial_number": "2020-046",
  "publish_date": "15-09-2020 11:33:00",
  "description": "On 11th of August 2020, Microsoft released a critical security advisory affecting all supported versions of Windows Server. The vulnerability is described as Netlogon Elevation of Privilege and got assigned CVE-2020-1472.<br>On 11th of September 2020, Secura released a white paper and testing tool for the vulnerability. The paper describes how an attacker with a foothold on a victim network could leverage this vulnerability to compromise an unpatched Domain Controller. The attacker can obtain domain admin privileges by taking advantage of flaws in a cryptographic authentication protocol.<br>Starting on the 14th of September 2020, several security researchers modified the initial testing tool created by Secura to provide full proof of concept of the vulnerability, allowing any attacker with a foothold on a victim network to easily elevate its privileges to domain admin.<br>On 23rd of September 2020, SAMBA also released security patches addressing the vulnerability, explaining that SAMBA server is vulnerable if used as a Domain Controller.<br>On 24th of September 2020, Microsoft Security Intelligence warned that ongoing attacks were being observed abusing Zerologon vulnerability.",
  "url_title": "2020-046",
  "content_markdown": "---\ntitle: 'Zerologon Critical Vulnerability Affecting Windows Domain Controllers'\nversion: '1.1'\nnumber: '2020-046'\ndate: 'September 25, 2020'\n---\n\n_History:_\n\n* _15/09/2020 --- v1.0 -- Initial publication_\n* _25/09/2020 --- v1.1 -- Updated with details on attacks, SAMBA, and new detection methods_\n\n# Summary\n\nOn 11th of August 2020, Microsoft released a critical security advisory affecting all supported versions of Windows Server [1]. The vulnerability is described as *Netlogon Elevation of Privilege* and got assigned CVE-2020-1472 [2].\n\nOn 11th of September 2020, Secura released a white paper [3] and testing tool [4] for the vulnerability. The paper^[*Zerologon: Unauthenticated domain controller compromise by subverting Netlogon cryptography (CVE-2020-1472)*] describes how an attacker with a foothold on a victim network could leverage this vulnerability to compromise an unpatched Domain Controller. The attacker can obtain domain admin privileges by taking advantage of flaws in a cryptographic authentication protocol.\n\nStarting on the 14th of September 2020, several _security researchers_ modified the initial testing tool created by Secura to provide full proof of concept of the vulnerability, allowing any attacker with a foothold on a victim network to easily elevate its privileges to domain admin.\n\nOn 23rd of September 2020, SAMBA also released security patches addressing the vulnerability, explaining that SAMBA server is vulnerable if used as a Domain Controller [10].\n\nOn 24th of September 2020, Microsoft Security Intelligence warned that ongoing attacks were being observed abusing Zerologon vulnerability [6].\n\n# Technical Details\n\nThe vulnerability was assigned *CVE-2020-1472* [2] with a CVSS score of 10.\n\nThe core of the vulnerability is due to an insecure use of AES-CFB8: When using EAS, the `ComputeNetlogonCredential` function makes use of CFB8 (8-bit cipher feedback) mode for block cipher operation, but wrongly uses a fixed value as an initialisation vector (16 zero bytes). Because of that, for 1 in 256 keys, applying AES-CFB8 encryption to an all-zero plaintext will result in all-zero ciphertext.\n\nSeveral steps are then needed to exploit this weakness:\n\n * Step 1: Spoofing client credentials by using brute-force authentication attack (average attempts: 256) with a challenge value of 8 zeroes.\n * Step 2: Disabling signing and sealing by unsetting a flag in the `NetrServerAuthenticate3` call, leading to requesting a session without encryption.\n * Step 3: Spoofing the first call after authentication by setting timestamp value to 0 (January 1st, 1970).\n * Step 4: Changing a computer’s AD password by using the `NetrServerPasswordSet2` call with a plaintext value of 516 zeroes, which lead to the computer password to be set as empty.\n * Step 5: From password change to domain admin by performing the attack on the Domain Controller itself and running a DCsynch attack with the newly emptied password.\n\n## Detection\n\nSince the initial release of information about this vulnerability, several security researchers provided more information on detection of Zerologon attacks [7, 8]. Also Microsoft provided a way to enforce usage of secure RPC with Netlogon secure channel between member computers and Active Directory (AD) Domain Controllers (DC) [9].\n\nThere is three specific steps of the attack which provide possibilities for defenders to detect exploitation of the vulnerability:\n\n### Initial Spoofing of Client Credentials\n\nWhen initiating the attack, it is necessary to perform several authentication attempts before getting the expected cyphertext value (all-zero) as described in the tester script [4]:\n\n\t# Keep authenticating until successful. Expected average number of attempts needed: 256.\n\nIt means that several events may be triggered during this step of the attack so some monitoring may be used to detect attempts to exploit the vulnerability:\n\n* Monitor network traffic for high number of `NetrServerReqChallenge` and/or `NetrServerAuthenticate3` RPC operations\n* Monitor Windows events for high number of failed machine account netlogon authentication on domain controller (EventID=5805)\n\n### DCSync\n\nThe last step of the attack consist of performing a DCSync attack on the targeted Domain Controller (In the paper, researcher use *Impacket’s* `secretsdump` script). It means that usual way to detect DCSync attack can be used:\n\n* Monitor network traffic for `DRSUAPI` RPC requests (operation `DsGetNCChanges`) and compare the source host against a list of known domain controllers\n* Monitor Windows events for EventID 4662 with GUID = `{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}` (`DS-Replication-Get-Changes-All` Control access right) [5]\n\n\n### Modification of machine credentials\n\nWhen the attack is successful, computer's AD password will be modified, triggering one or several detection possibilities:\n\n* Monitor Windows events for Change of computer account (EventID=4742) by an anonymous logon\n* Monitor Windows events for succesful login (EventID=4624) followed by an password account reset (EventID=4624)\n\n# Products Affected\n\nThis vulnerability affects the following Microsoft Server versions:\n\n* Windows Server 2008 R2 for x64-based Systems Service Pack 1\n* Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)\n* Windows Server 2012\n* Windows Server 2012 (Server Core installation)\n* Windows Server 2012 R2\n* Windows Server 2012 R2 (Server Core installation)\n* Windows Server 2016\n* Windows Server 2016 (Server Core installation)\n* Windows Server 2019\n* Windows Server 2019 (Server Core installation)\n* Windows Server, version 1903 (Server Core installation)\n* Windows Server, version 1909 (Server Core installation)\n* Windows Server, version 2004 (Server Core installation)\n\nThis vulnerability also affects SAMBA server if used as Domain Controller:\n\n * Samba 4.0 and later\n\n# Recommendations\n\nCERT-EU recommends updating following Microsoft guidance as soon as possible [1].\n\nIf some 3rd party devices needs to communicate with Domain controllers, it is also recommended to enforce usage of secure RPC with Netlogon secure channel and create exceptions for devices not able to communicate securely, as described by Microsoft [9].\n\nRegarding SAMBA server, if used as domain controller, it is also highly recommended to patch as soon as possible [10].\n\n# References\n\n[1] <https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472>\n\n[2] <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1472>\n\n[3] <https://www.secura.com/pathtoimg.php?id=2055>\n\n[4] <https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py>\n\n[5] <https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb>\n\n[6] <https://twitter.com/MsftSecIntel/status/1308941504707063808>\n\n[7] <https://www.lares.com/blog/from-lares-labs-defensive-guidance-for-zerologon-cve-2020-1472/>\n\n[8] <https://blog.zsec.uk/zerologon-attacking-defending/>\n\n[9] <https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc>\n\n[10] <https://www.samba.org/samba/security/CVE-2020-1472.html>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>15/09/2020 --- v1.0 -- Initial publication</em></li><li><em>25/09/2020 --- v1.1 -- Updated with details on attacks, SAMBA, and new detection methods</em></li></ul><h2 id=\"summary\">Summary</h2><p>On 11th of August 2020, Microsoft released a critical security advisory affecting all supported versions of Windows Server [1]. The vulnerability is described as <em>Netlogon Elevation of Privilege</em> and got assigned CVE-2020-1472 [2].</p><p>On 11th of September 2020, Secura released a white paper [3] and testing tool [4] for the vulnerability. The paper^[<em>Zerologon: Unauthenticated domain controller compromise by subverting Netlogon cryptography (CVE-2020-1472)</em>] describes how an attacker with a foothold on a victim network could leverage this vulnerability to compromise an unpatched Domain Controller. The attacker can obtain domain admin privileges by taking advantage of flaws in a cryptographic authentication protocol.</p><p>Starting on the 14th of September 2020, several <em>security researchers</em> modified the initial testing tool created by Secura to provide full proof of concept of the vulnerability, allowing any attacker with a foothold on a victim network to easily elevate its privileges to domain admin.</p><p>On 23rd of September 2020, SAMBA also released security patches addressing the vulnerability, explaining that SAMBA server is vulnerable if used as a Domain Controller [10].</p><p>On 24th of September 2020, Microsoft Security Intelligence warned that ongoing attacks were being observed abusing Zerologon vulnerability [6].</p><h2 id=\"technical-details\">Technical Details</h2><p>The vulnerability was assigned <em>CVE-2020-1472</em> [2] with a CVSS score of 10.</p><p>The core of the vulnerability is due to an insecure use of AES-CFB8: When using EAS, the <code>ComputeNetlogonCredential</code> function makes use of CFB8 (8-bit cipher feedback) mode for block cipher operation, but wrongly uses a fixed value as an initialisation vector (16 zero bytes). Because of that, for 1 in 256 keys, applying AES-CFB8 encryption to an all-zero plaintext will result in all-zero ciphertext.</p><p>Several steps are then needed to exploit this weakness:</p><ul><li>Step 1: Spoofing client credentials by using brute-force authentication attack (average attempts: 256) with a challenge value of 8 zeroes.</li><li>Step 2: Disabling signing and sealing by unsetting a flag in the <code>NetrServerAuthenticate3</code> call, leading to requesting a session without encryption.</li><li>Step 3: Spoofing the first call after authentication by setting timestamp value to 0 (January 1st, 1970).</li><li>Step 4: Changing a computer’s AD password by using the <code>NetrServerPasswordSet2</code> call with a plaintext value of 516 zeroes, which lead to the computer password to be set as empty.</li><li>Step 5: From password change to domain admin by performing the attack on the Domain Controller itself and running a DCsynch attack with the newly emptied password.</li></ul><h3 id=\"detection\">Detection</h3><p>Since the initial release of information about this vulnerability, several security researchers provided more information on detection of Zerologon attacks [7, 8]. Also Microsoft provided a way to enforce usage of secure RPC with Netlogon secure channel between member computers and Active Directory (AD) Domain Controllers (DC) [9].</p><p>There is three specific steps of the attack which provide possibilities for defenders to detect exploitation of the vulnerability:</p><h4 id=\"initial-spoofing-of-client-credentials\">Initial Spoofing of Client Credentials</h4><p>When initiating the attack, it is necessary to perform several authentication attempts before getting the expected cyphertext value (all-zero) as described in the tester script [4]:</p><pre><code># Keep authenticating until successful. Expected average number of attempts needed: 256.\n</code></pre><p>It means that several events may be triggered during this step of the attack so some monitoring may be used to detect attempts to exploit the vulnerability:</p><ul><li>Monitor network traffic for high number of <code>NetrServerReqChallenge</code> and/or <code>NetrServerAuthenticate3</code> RPC operations</li><li>Monitor Windows events for high number of failed machine account netlogon authentication on domain controller (EventID=5805)</li></ul><h4 id=\"dcsync\">DCSync</h4><p>The last step of the attack consist of performing a DCSync attack on the targeted Domain Controller (In the paper, researcher use <em>Impacket’s</em> <code>secretsdump</code> script). It means that usual way to detect DCSync attack can be used:</p><ul><li>Monitor network traffic for <code>DRSUAPI</code> RPC requests (operation <code>DsGetNCChanges</code>) and compare the source host against a list of known domain controllers</li><li>Monitor Windows events for EventID 4662 with GUID = <code>{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}</code> (<code>DS-Replication-Get-Changes-All</code> Control access right) [5]</li></ul><h4 id=\"modification-of-machine-credentials\">Modification of machine credentials</h4><p>When the attack is successful, computer's AD password will be modified, triggering one or several detection possibilities:</p><ul><li>Monitor Windows events for Change of computer account (EventID=4742) by an anonymous logon</li><li>Monitor Windows events for succesful login (EventID=4624) followed by an password account reset (EventID=4624)</li></ul><h2 id=\"products-affected\">Products Affected</h2><p>This vulnerability affects the following Microsoft Server versions:</p><ul><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li><li>Windows Server 2012</li><li>Windows Server 2012 (Server Core installation)</li><li>Windows Server 2012 R2</li><li>Windows Server 2012 R2 (Server Core installation)</li><li>Windows Server 2016</li><li>Windows Server 2016 (Server Core installation)</li><li>Windows Server 2019</li><li>Windows Server 2019 (Server Core installation)</li><li>Windows Server, version 1903 (Server Core installation)</li><li>Windows Server, version 1909 (Server Core installation)</li><li>Windows Server, version 2004 (Server Core installation)</li></ul><p>This vulnerability also affects SAMBA server if used as Domain Controller:</p><ul><li>Samba 4.0 and later</li></ul><h2 id=\"recommendations\">Recommendations</h2><p>CERT-EU recommends updating following Microsoft guidance as soon as possible [1].</p><p>If some 3rd party devices needs to communicate with Domain controllers, it is also recommended to enforce usage of secure RPC with Netlogon secure channel and create exceptions for devices not able to communicate securely, as described by Microsoft [9].</p><p>Regarding SAMBA server, if used as domain controller, it is also highly recommended to patch as soon as possible [10].</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472\">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1472\">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1472</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.secura.com/pathtoimg.php?id=2055\">https://www.secura.com/pathtoimg.php?id=2055</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py\">https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb\">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/MsftSecIntel/status/1308941504707063808\">https://twitter.com/MsftSecIntel/status/1308941504707063808</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.lares.com/blog/from-lares-labs-defensive-guidance-for-zerologon-cve-2020-1472/\">https://www.lares.com/blog/from-lares-labs-defensive-guidance-for-zerologon-cve-2020-1472/</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.zsec.uk/zerologon-attacking-defending/\">https://blog.zsec.uk/zerologon-attacking-defending/</a></p><p>[9] <a rel=\"noopener\" target=\"_blank\" href=\"https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc\">https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc</a></p><p>[10] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.samba.org/samba/security/CVE-2020-1472.html\">https://www.samba.org/samba/security/CVE-2020-1472.html</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  }
}