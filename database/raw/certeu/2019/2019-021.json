{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2019-021.pdf"
  },
  "title": "Detecting and Preventing Emotet 2019 Campaign",
  "serial_number": "2019-021",
  "publish_date": "30-09-2019 09:18:00",
  "description": "Since beginning of June 2019, the Emotet botnet stopped sending phishing emails to infect new victims. However, on August 22nd, 2019, the known Command-and-Control (CnC) servers started responding again. Since September 16th, 2019, CERT-EU has been observing new phishing campaigns. To detect and prevent infection, CERT-EU analysed the behavior of those new versions of Emotet and hereby provides some recommendations for the SOC teams.",
  "url_title": "2019-021",
  "content_markdown": "---\ntitle: 'Detecting and Preventing Emotet 2019 Campaign'\nversion: '1.0'\nnumber: '2019-021'\ndate: 'September 30, 2019'\n---\n\n_History:_\n\n* _30/09/2019 --- v1.0 -- Initial publication_\n\n# Summary\n\nSince beginning of June 2019, the Emotet botnet stopped sending phishing emails to infect new victims. However, on August 22nd, 2019, the known Command-and-Control (CnC) servers started responding again [1]. Since September 16th, 2019, CERT-EU has been observing new phishing campaigns. To detect and prevent infection, CERT-EU analysed the behavior of those new versions of Emotet and hereby provides some recommendations for the SOC teams.\n\n\n# Technical Details\n\nCERT-EU has observed several phishing campaigns delivering Emotet malware. All of them consisted of malicious MS Office document spawning **PowerShell** commands. Based on open-source information, there exists also a **Wscript** version [2], however, as we did not observe this strain, this advisory will focus on the **Powershell** version.\n\nIn the observed cases, the malicious MS Office document contains a macro. If the user clicks on **Enable Editing** and **Enable Content**, the macro will then spawn a Powershell command via a WMI Call. The Powershell command is base64-encoded and loops through different URLs (usually 5) to download and execute the Emotet malware.\n\nOnce installed, the Emotet malware will communicate via POST requests over HTTP with CnC servers [4].\n\n# Recommendations\n\n## Detection\n\nThere are several ways to detect Emotet infections. The most appropriate one depends on the visibility of the infrastructure and the stage of the infection. We present here three successful approaches to detect suspicious events generated by the 2019 Emotet campaign.\n\n### Detecting Initial Infection with Endpoint Monitoring\n\nIf the SOC has visibility on endpoint activity -- especially process creation -- it is possible to detect when a user has been tricked into opening a malicious document and activating content.\n\nThe initial infection happens when the user executes a macro embedded in a MS Office document (email attachment or downloaded via a link). The macro will then spawn a Powershell obfuscated command via WMI call. To detect suspicious event, SOC teams can trigger alerts when `powershell.exe` process is spawned by a `wmiprvse.exe` process as follows (Splunk syntax):\n\n    ParentImage=\"*\\\\wmiprvse.exe\" AND Image=\"*\\\\powershell.exe\"\n\nHowever, depending on the environment, such query may generate false positives. If the SOC has visibility on the executed command line, it is possible to be more specific as both processes have specific options in the command line:\n\n - `wmiprvse.exe` is called with the following options: `-secured -Embedding`\n - `powershell.exe` is using base64-encoded command, which can be called with any reduction of the `encoded` option (`-e`, `-en`, `-enc` ...)\n\nThe following query should reduce the amount of false positive (Splunk syntax):\n\n    ParentImage=\"*\\\\wmiprvse.exe\" AND Image=\"*\\\\powershell.exe\" AND ParentCommandLine=\"*-secured*\" AND CommandLine=\"*-e*\"\n\n### Detecting Download of 2nd Stage\n\nIf the Powershell command is successfully executed, the malicious base64-encoded command will try to download the 2nd stage malware from different locations (usually 5). The script will stop when a download is successful.\n\nIt is possible to extract the URLs used to download the malicious binary from the base64-encoded string using a simple CyberChef [3] recipe as follows:\n\n    From_Base64('A-Za-z0-9+/=',true)\n    Remove_null_bytes()\n    Extract_URLs(false)\n    Find_/_Replace({'option':'Simple string','string':'\\''},'',true,false,true,false)\n    Split('@','\\\\n')\n\nBy looking at DNS or Proxy logs, it is possible to roughly identify a successful infection:\n\n- If all the extracted URLs/domains are contacted, the download was probably not successful (blacklist/website down/etc.).\n- If only one or two of the URLs/domains were contacted and the command stopped before looping through all the possibilities, than the second stage was most probably downloaded.\n\n\n### Detecting CnC Communication with Proxy Logs\n\nThe 2nd stage malware use a very specific pattern for CnC communications [4]:\n\n - POST request over HTTP,\n - to an IP addresses (no DNS resolution),\n - using a limited list of keyword in the URL path.\n\nIt is possible to detect such pattern with the following search in proxy logs (Splunk syntax):\n\n    http_method=POST AND (\"/teapot/\" OR \"/pnp/\" OR \"/tpt/\" OR \"/splash/\" OR \"/site/\" OR \"/codec/\" OR \"/health/\" OR \"/balloon/\" OR \"/cab/\" OR \"/odbc/\" OR \"/badge/\" OR \"/dma/\" OR \"/psec/\" OR \"/cookies/\" OR \"/iplk/\" OR \"/devices/\" OR \"/enable/\" OR \"/mult/\" OR \"/prov/\" OR \"/vermont/\" OR \"/attrib/\" OR \"/schema/\" OR \"/iab/\" OR \"/chunk/\" OR \"/publish/\" OR \"/prep/\" OR \"/srvc/\" OR \"/sess/\" OR \"/ringin/\" OR \"/nsip/\" OR \"/stubs/\" OR \"/img/\" OR \"/add/\" OR \"/xian/\" OR \"/jit/\" OR \"/free/\" OR \"/pdf/\" OR \"/loadan/\" OR \"/arizona/\" OR \"/tlb/\" OR \"/forced/\" OR \"/results/\" OR \"/symbols/\" OR \"/rep|t/\" OR \"/guids/\" OR \"/taskbar/\" OR \"/child/\" OR \"/cone/\" OR \"/glitch/\" OR \"/entries/\" OR \"/between/\" OR \"/bml/\" OR \"/usbccid/\" OR \"/sym/\" OR \"/enabled/\" OR \"/merge/\" OR \"/window/\" OR \"/scripts/\" OR \"/raster/\" OR \"/acquire/\" OR \"/json/\" OR \"/rtm/\" OR \"/walk/\" OR \"/ban/\") | regex \"http://\\d{1,3}.\\d{1,3}.\\d{1,3}.\\d{1,3}\"\n\n\n## Prevention\n\nAs explained before, Emotet infection relies on usual tricks to infect target like embedded macros and Powershell encoded commands. There are several strategies to prevent infections using these techniques, such as banning execution of MS Office macros or disabling Powershell script execution. Those strategies are not being always applicable because of IT of business needs.\n\nHowever, it is possible to block the download of the second stage by forbidding Powershell process to download anything from Internet via local firewall rules [5].\n\nThere are two approaches possible to perform that:\n\n - block all network connections for Powershell, or\n - block communication with the proxy server for Powershell.\n\nThe firewall rules need to be applied for **all versions of PowerShell** installed on workstations.\n\nMore information on securing Powershell may also be found in [6] and [7].\n\n# References\n\n[1] <https://twitter.com/MalwareTechBlog/status/1164616966499254272>\n\n[2] <https://www.bleepingcomputer.com/news/security/emotet-trojan-evolves-since-being-reawakend-here-is-what-we-know/>\n\n[3] <https://gchq.github.io/CyberChef/>\n\n[4] <https://blog.trendmicro.com/trendlabs-security-intelligence/emotet-adds-new-evasion-technique-and-uses-connected-devices-as-proxy-cc-servers/>\n\n[5] <https://isc.sans.edu/forums/diary/Blocking+Powershell+Connection+via+Windows+Firewall/21829/>\n\n[6] <https://www.cyber.gov.au/publications/securing-powershell-in-the-enterprise>\n\n[7] <https://media.cert.europa.eu/static/WhitePapers/CERT-EU-SWP2019-001.pdf>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>30/09/2019 --- v1.0 -- Initial publication</em></li></ul><h2 id=\"summary\">Summary</h2><p>Since beginning of June 2019, the Emotet botnet stopped sending phishing emails to infect new victims. However, on August 22nd, 2019, the known Command-and-Control (CnC) servers started responding again [1]. Since September 16th, 2019, CERT-EU has been observing new phishing campaigns. To detect and prevent infection, CERT-EU analysed the behavior of those new versions of Emotet and hereby provides some recommendations for the SOC teams.</p><h2 id=\"technical-details\">Technical Details</h2><p>CERT-EU has observed several phishing campaigns delivering Emotet malware. All of them consisted of malicious MS Office document spawning <strong>PowerShell</strong> commands. Based on open-source information, there exists also a <strong>Wscript</strong> version [2], however, as we did not observe this strain, this advisory will focus on the <strong>Powershell</strong> version.</p><p>In the observed cases, the malicious MS Office document contains a macro. If the user clicks on <strong>Enable Editing</strong> and <strong>Enable Content</strong>, the macro will then spawn a Powershell command via a WMI Call. The Powershell command is base64-encoded and loops through different URLs (usually 5) to download and execute the Emotet malware.</p><p>Once installed, the Emotet malware will communicate via POST requests over HTTP with CnC servers [4].</p><h2 id=\"recommendations\">Recommendations</h2><h3 id=\"detection\">Detection</h3><p>There are several ways to detect Emotet infections. The most appropriate one depends on the visibility of the infrastructure and the stage of the infection. We present here three successful approaches to detect suspicious events generated by the 2019 Emotet campaign.</p><h4 id=\"detecting-initial-infection-with-endpoint-monitoring\">Detecting Initial Infection with Endpoint Monitoring</h4><p>If the SOC has visibility on endpoint activity -- especially process creation -- it is possible to detect when a user has been tricked into opening a malicious document and activating content.</p><p>The initial infection happens when the user executes a macro embedded in a MS Office document (email attachment or downloaded via a link). The macro will then spawn a Powershell obfuscated command via WMI call. To detect suspicious event, SOC teams can trigger alerts when <code>powershell.exe</code> process is spawned by a <code>wmiprvse.exe</code> process as follows (Splunk syntax):</p><pre><code>ParentImage=\"*\\\\wmiprvse.exe\" AND Image=\"*\\\\powershell.exe\"\n</code></pre><p>However, depending on the environment, such query may generate false positives. If the SOC has visibility on the executed command line, it is possible to be more specific as both processes have specific options in the command line:</p><ul><li><code>wmiprvse.exe</code> is called with the following options: <code>-secured -Embedding</code></li><li><code>powershell.exe</code> is using base64-encoded command, which can be called with any reduction of the <code>encoded</code> option (<code>-e</code>, <code>-en</code>, <code>-enc</code> ...)</li></ul><p>The following query should reduce the amount of false positive (Splunk syntax):</p><pre><code>ParentImage=\"*\\\\wmiprvse.exe\" AND Image=\"*\\\\powershell.exe\" AND ParentCommandLine=\"*-secured*\" AND CommandLine=\"*-e*\"\n</code></pre><h4 id=\"detecting-download-of-2nd-stage\">Detecting Download of 2nd Stage</h4><p>If the Powershell command is successfully executed, the malicious base64-encoded command will try to download the 2nd stage malware from different locations (usually 5). The script will stop when a download is successful.</p><p>It is possible to extract the URLs used to download the malicious binary from the base64-encoded string using a simple CyberChef [3] recipe as follows:</p><pre><code>From_Base64('A-Za-z0-9+/=',true)\nRemove_null_bytes()\nExtract_URLs(false)\nFind_/_Replace({'option':'Simple string','string':'\\''},'',true,false,true,false)\nSplit('@','\\\\n')\n</code></pre><p>By looking at DNS or Proxy logs, it is possible to roughly identify a successful infection:</p><ul><li>If all the extracted URLs/domains are contacted, the download was probably not successful (blacklist/website down/etc.).</li><li>If only one or two of the URLs/domains were contacted and the command stopped before looping through all the possibilities, than the second stage was most probably downloaded.</li></ul><h4 id=\"detecting-cnc-communication-with-proxy-logs\">Detecting CnC Communication with Proxy Logs</h4><p>The 2nd stage malware use a very specific pattern for CnC communications [4]:</p><ul><li>POST request over HTTP,</li><li>to an IP addresses (no DNS resolution),</li><li>using a limited list of keyword in the URL path.</li></ul><p>It is possible to detect such pattern with the following search in proxy logs (Splunk syntax):</p><pre><code>http_method=POST AND (\"/teapot/\" OR \"/pnp/\" OR \"/tpt/\" OR \"/splash/\" OR \"/site/\" OR \"/codec/\" OR \"/health/\" OR \"/balloon/\" OR \"/cab/\" OR \"/odbc/\" OR \"/badge/\" OR \"/dma/\" OR \"/psec/\" OR \"/cookies/\" OR \"/iplk/\" OR \"/devices/\" OR \"/enable/\" OR \"/mult/\" OR \"/prov/\" OR \"/vermont/\" OR \"/attrib/\" OR \"/schema/\" OR \"/iab/\" OR \"/chunk/\" OR \"/publish/\" OR \"/prep/\" OR \"/srvc/\" OR \"/sess/\" OR \"/ringin/\" OR \"/nsip/\" OR \"/stubs/\" OR \"/img/\" OR \"/add/\" OR \"/xian/\" OR \"/jit/\" OR \"/free/\" OR \"/pdf/\" OR \"/loadan/\" OR \"/arizona/\" OR \"/tlb/\" OR \"/forced/\" OR \"/results/\" OR \"/symbols/\" OR \"/rep|t/\" OR \"/guids/\" OR \"/taskbar/\" OR \"/child/\" OR \"/cone/\" OR \"/glitch/\" OR \"/entries/\" OR \"/between/\" OR \"/bml/\" OR \"/usbccid/\" OR \"/sym/\" OR \"/enabled/\" OR \"/merge/\" OR \"/window/\" OR \"/scripts/\" OR \"/raster/\" OR \"/acquire/\" OR \"/json/\" OR \"/rtm/\" OR \"/walk/\" OR \"/ban/\") | regex \"http://\\d{1,3}.\\d{1,3}.\\d{1,3}.\\d{1,3}\"\n</code></pre><h3 id=\"prevention\">Prevention</h3><p>As explained before, Emotet infection relies on usual tricks to infect target like embedded macros and Powershell encoded commands. There are several strategies to prevent infections using these techniques, such as banning execution of MS Office macros or disabling Powershell script execution. Those strategies are not being always applicable because of IT of business needs.</p><p>However, it is possible to block the download of the second stage by forbidding Powershell process to download anything from Internet via local firewall rules [5].</p><p>There are two approaches possible to perform that:</p><ul><li>block all network connections for Powershell, or</li><li>block communication with the proxy server for Powershell.</li></ul><p>The firewall rules need to be applied for <strong>all versions of PowerShell</strong> installed on workstations.</p><p>More information on securing Powershell may also be found in [6] and [7].</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/MalwareTechBlog/status/1164616966499254272\">https://twitter.com/MalwareTechBlog/status/1164616966499254272</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/security/emotet-trojan-evolves-since-being-reawakend-here-is-what-we-know/\">https://www.bleepingcomputer.com/news/security/emotet-trojan-evolves-since-being-reawakend-here-is-what-we-know/</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://gchq.github.io/CyberChef/\">https://gchq.github.io/CyberChef/</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.trendmicro.com/trendlabs-security-intelligence/emotet-adds-new-evasion-technique-and-uses-connected-devices-as-proxy-cc-servers/\">https://blog.trendmicro.com/trendlabs-security-intelligence/emotet-adds-new-evasion-technique-and-uses-connected-devices-as-proxy-cc-servers/</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://isc.sans.edu/forums/diary/Blocking+Powershell+Connection+via+Windows+Firewall/21829/\">https://isc.sans.edu/forums/diary/Blocking+Powershell+Connection+via+Windows+Firewall/21829/</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.cyber.gov.au/publications/securing-powershell-in-the-enterprise\">https://www.cyber.gov.au/publications/securing-powershell-in-the-enterprise</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://media.cert.europa.eu/static/WhitePapers/CERT-EU-SWP2019-001.pdf\">https://media.cert.europa.eu/static/WhitePapers/CERT-EU-SWP2019-001.pdf</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  }
}