{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2017-012.pdf"
  },
  "title": "UPDATE! WannaCry Ransomware Campaign Exploiting SMB Vulnerability",
  "serial_number": "2017-012",
  "publish_date": "22-05-2017 13:46:00",
  "description": "A large ransomware campaign has been observed since Friday, May 12th, 2017. The payload delivered is a variant of ransomware malware called WannaCry. It appears to infect computers through a recent SMB vulnerability in Microsoft Windows operating system (CVE-2017-0145).",
  "url_title": "2017-012",
  "content_markdown": "---\ntitle: 'WannaCry Ransomware Campaign Exploiting SMB Vulnerability'\nversion: '1.6'\nnumber: '2017-012'\ndate: 'May 22, 2017'\n---\n\n_History:_\n\n* _12/05/2017 --- v1.0: Initial publication_\n* _13/05/2017 --- v1.1: Additional information about ways to defend and new patches added_\n* _15/05/2017 --- v1.2: Additional variants discovered and a new tool published_\n* _15/05/2017 --- v1.3: Some wording changed_\n* _16/05/2017 --- v1.4: Additional variants with new killswitches discovered_\n* _18/05/2017 --- v1.5: Encryption key recovery sometimes possible_\n* _22/05/2017 --- v1.6: Better tool available for recovering encrypted files; other campaigns identified_\n\n# Summary\n\nA large ransomware campaign has been observed since Friday, May 12th, 2017. The payload delivered is a variant of ransomware malware called **WannaCry**. It appears to infect computers through a recent SMB vulnerability in Microsoft Windows operating system [1, 2, 3, 7, 12, 13] (CVE-2017-0145).\n\nThe exploit used -- _EternalBlue_ -- has been made available on the Internet through the _ShadowBrokers_ dump on April 14th, 2017 [6], but already earlier patched by Microsoft on March 14th, 2017 as part of MS17-010 [3] for the supported versions of the Microsoft Windows operating system. Unfortunately, the patch was not available at that time for legacy Windows XP, Windows 8, as well as for Windows Server 2003 systems. Even in case of systems where the patch was available, it appears that many organizations have not installed it. There were more than 200 000 computers affected world-wide with some prominent organizations including Telefonica [4] in Spain and NHS hospitals in UK [5].\n\nAs of May 13th, 2017, due to the seriousness of the threat, **Microsoft has made available the patch MS17-010** [9] also for earlier (no longer supported) versions of Microsoft Windows operating system, such as **Windows XP**, **Windows 8**, and **Windows Server 2003**.\n\nA tool called _**wanakiwi**_ has been recently made available that **may make it possible to recover the encrypted files** on Windows XP, Windows 7, Windows Vista, Windows Server 2003 and 2008, if the system was not rebooted after the infection [16].\n\nOther campaigns leveraging the tools leaked by the _ShadowBrokers_ have been identified [18, 19]. While they do not deliver ransomware, they may be used for other purposes and represent a significant threat. The other campaigns share the same infection method -- SMB. It is important to monitor network activity even if no ransomware cases have been observed.\n\n# Technical Details\n\nThe campaign uses an exploit for a recent SMB protocol vulnerability in Microsoft Windows [1, 2, 3, 7]. According to [7], the ransomware perpetrators incorporated publicly-available exploit code for the patched SMB _EternalBlue_ vulnerability, CVE-2017-0145, which can be triggered by sending a specially crafted packet to a targeted SMB server. It spreads initially through vulnerable computers exposing port 445 on the Internet, and then using the same technique propagating through the internal network.\n\nFollowing [7], the threat arrives as a dropper that has the following two components:\n\n* A component that tries to exploit the SMB _EternalBlue_ vulnerability in other computers.\n* Ransomware known as _WannaCry_/_WannaCrypt_.\n\nThe dropper -- depending on the version -- tries to connect to one of the following (_killswitch_) domains [7, 8, 10, 14]:\n\n\tiuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com\n\tifferfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com\n\tayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf[.]com\n\tlazarusse.suiche.sdfjhgosurijfaqwqwqrgwea[.]com\n\nThese domains have been **sinkholed** by MalwareTech [8] and others. **If the connection is successful**, the threat **does not infect** the system further with ransomware or try to exploit other systems to spread; it simply stops execution. However, if the connection fails, the dropper proceeds to drop the ransomware and creates a service on the system. Hence, it is imperative to **enable access to this domain**, by either:\n\n* enabling access to this domain on the Internet -- the malware is not proxy-aware, so if a proxy use is required, this may fail;\n* redirecting the requests to this domain (through local DNS or proxy re-writing, etc.) to a webserver that will respond with HTTP code 200 to any request.\n\nIn either case, it is worth to **monitor the requests** as the machines initiating these requests most likely had been infected with the WannaCray ransomware.\n\nThe threat creates a service named `mssecsvc2.0`, whose function is to exploit the SMB vulnerability in other computers accessible from the infected system. Once at least one computer in local network is infected, the malware will automatically spread using the SMB protocol on TCP port 445 [7]. It is important to mention that **unpatched** computers and networks exposing SMB protocol on the Internet may be directly infected without the need for any other delivery mechanism. It is sufficient that they are powered-up and accepting SMB protocol connections. Recent analysis [12, 13] also indicates that if a target system is infected with _DoublePulsar_ backdoor, it will be automatically exploited. Also, once a new system is infected, _DoublePulsar_ will be installed as well.\n\nThe malware used in the attacks encrypts the files and also drops and executes a decryptor tool. Then, the malware requests around $300 in Bitcoin for obtaining a decryption key. The decryption tool clearly supports multiple countries, as it provides the interface in several languages. For command and control, the malware extracts and uses Tor service executable with all necessary dependencies to access the Tor network. More analysis may be found in [2] and [7].\n\nThe file extensions that the malware is targeting contain certain clusters of formats including [2]:\n\n* Commonly used office file extensions (`.ppt`, `.doc`, `.docx`, `.xlsx`, `.sxi`).\n* Less common and nation-specific office formats (`.sxw`, `.odt`, `.hwp`).\n* Archives, media files (`.zip`, `.rar`, `.tar`, `.bz2`, `.mp4`, `.mkv`).\n* Emails and email databases (`.eml`, `.msg`, `.ost`, `.pst`, `.edb`).\n* Database files (`.sql`, `.accdb`, `.mdb`, `.dbf`, `.odb`, `.myd`).\n* Developers’ sourcecode and project files (`.php`, `.java`, `.cpp`, `.pas`, `.asm`).\n* Encryption keys and certificates (`.key`, `.pfx`, `.pem`, `.p12`, `.csr`, `.gpg`, `.aes`).\n* Graphic designers, artists and photographers files (`.vsd`, `.odg`, `.raw`, `.nef`, `.svg`, `.psd`).\n* Virtual machine files (`.vmx`, `.vmdk`, `.vdi`).\n\n## Other Related Campaigns\n\nSince the start of the _WannaCry_ campaign, there has been a lot of interest and research performed. This allowed to also identify other campaigns exploiting the vulnerabilities published by the _ShadowBrokers_, such as _BlueDoom_ [18] or _EternalRocks_ [19], and others. Some of these campaigns have started prior to the _WannaCry_, and other later. They all share the same infection vector, but the differ in the activity performed after infection. Some are used to mine _Monero_ cryptocurrency, others install backdoors that could be used later, but do not perform any additional visible actions for the moment. Most of these additional campaigns do not use any type of _killswitch_.\n\nSince the initial infection for all these related campaigns appears to be using the same infection vector, it is important to monitor networks for activity related to _EternalBlue_ even if no ransomware infections have been observed. There may be machines infected with any of the other campaigns. The following SNORT rules may be used to detect network activity related to _EternalBlue_ [17]:\n\n\talert tcp $HOME_NET 445 -> any any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response”; flow:from_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:2;)\n\n\talert smb any any -> $HOME_NET any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Request (set)”; flow:to_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 18 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:set,ETPRO.ETERNALBLUE; flowbits:noalert; classtype:trojan-activity; sid:2024220; rev:1;)\n\n\talert smb $HOME_NET any -> any any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response”; flow:from_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:1;)\n\n# Products Affected\n\nThe following products known to be impacted if they are not patched [1, 3, 7]:\n\n* Microsoft Windows Vista SP2\n* Microsoft Windows Server 2008 SP2 and R2 SP1\n* Microsoft Windows 7\n* Microsoft Windows 8.1\n* Microsoft Windows RT 8.1\n* Microsoft Windows Server 2012 and R2\n\nIt has been recently confirmed [7] that the malware targets also earlier -- no longer supported -- version of the Microsoft operating system:\n\n* Windows XP\n* Windows 8\n* Windows Server 2003\n\nAt the same time, Microsoft has confirmed [7] that Windows 10 is not impacted by this attack at the moment. It is important to realize however that the attack may evolve and future versions may also target unpatched versions of Windows 10.\n\n# Recommendations\n\nA patch for the SMB vulnerability is available as Microsoft Security Bulletin **MS17-010** for the supported Microsoft Windows operating system versions [3]. It is imperative that this patch is installed. Since the threat appears to evolve (new variants, new _killswitch_ domains appearing), any measures relying on a specific characteristic of the variants currently used, should not be considered reliable.\n\nAdditionally, as of May 13th, 2017, due to the seriousness of the threat, **Microsoft has made available the patch MS17-010** [9] also for earlier (no longer supported) versions of Microsoft Windows operating system, such as **Windows XP**, **Windows 8**, and **Windows Server 2003**.\n\nAdditionally, the following measures should be taken as soon as possible [1, 7]:\n\n* Update system with Microsoft patch MS17-010 or upgrade to Windows 10.\n* Disable SMBv1 with the steps documented at Microsoft Knowledge Base Article 2696547.\n* Consider adding a rule on the firewall to block incoming SMB traffic on port 445.\n* Discover which systems within the network may be susceptible to attack and isolate them, update, and/or shut down.\n* For systems without support or patch available, it is recommended to isolate them from the network or shut down as the case may be. As an option, there has been a tool published [11], which can block execution of the malware on vulnerable systems.\n* In case of new infections, it is highly recommended to provide all workstations with access to the _killswitch_ domains as mentioned in the [Technical Details] section of this advisory.\n\nAs a general rule, the best defense against ransomware-type attacks are frequent and reliable backups. If a recent backup is available, the affected systems may be easily restored from backups.\n\nIn case of infection/encryption of files, there may be a possibility to **recover the encrypted files** on Windows XP, Windows 7, Windows Vista, Windows Server 2003 and 2008, if the system was not rebooted after the infection [16]. The _wanakiwi_ tool tries to recover the private user key in memory by searching for the two prime numbers used to generate the RSA key-pair during the WannaCry encryption process. The primes extraction method is based on Adrien Guinet's _wannakey_ [15], which consist of scanning the WannaCry process memory to recover the prime numbers that were not cleaned during `CryptReleaseContext()`.\n\nAlso, it should be kept in mind that making the ransomware payment does not guarantee that the attackers send the decryption key. Currently, there are no confirmed cases for this campaign indicating that paying the ransom actually allowed to decrypt the files.\n\n# References\n\n[1] <https://www.ccn-cert.cni.es/seguridad-al-dia/comunicados-ccn-cert/4464-ataque-masivo-de-ransomware-que-afecta-a-un-elevado-numero-de-organizaciones-espanolas.html>\n\n[2] <https://securelist.com/blog/incidents/78351/wannacry-ransomware-used-in-widespread-attacks-all-over-the-world/>\n\n[3] <https://technet.microsoft.com/en-us/library/security/ms17-010.aspx>\n\n[4] <https://blog.gdatasoftware.com/2017/05/29751-wannacry-ransomware-campaign>\n\n[5] <https://krebsonsecurity.com/2017/05/u-k-hospitals-hit-in-widespread-ransomware-attack/>\n\n[6] <https://support.kaspersky.com/shadowbrokers>\n\n[7] <https://blogs.technet.microsoft.com/mmpc/2017/05/12/wannacrypt-ransomware-worm-targets-out-of-date-systems/>\n\n[8] <https://intel.malwaretech.com/botnet/wcrypt>\n\n[9] <https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/>\n\n[10] <https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e>\n\n[11] <https://www.ccn-cert.cni.es/en/updated-security/ccn-cert-statements/4485-nomorecry-tool-ccn-cert-s-tool-to-prevent-the-execution-of-the-ransomware-wannacry.html>\n\n[12] <https://blog.malwarebytes.com/threat-analysis/2017/05/the-worm-that-spreads-wanacrypt0r/>\n\n[13] <https://www.endgame.com/blog/wcrywanacry-ransomware-technical-analysis>\n\n[14] <https://www.bleepingcomputer.com/news/security/wannacry-wana-decryptor-wanacrypt0r-info-and-technical-nose-dive/>\n\n[15] <https://github.com/aguinet/wannakey>\n\n[16] <https://github.com/gentilkiwi/wanakiwi>\n\n[17] <https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/>\n\n[18] <https://heimdalsecurity.com/blog/bluedoom-worm-eternablue-nsa-exploits/>\n\n[19] <https://www.bleepingcomputer.com/news/security/new-smb-worm-uses-seven-nsa-hacking-tools-wannacry-used-just-two/>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>12/05/2017 --- v1.0: Initial publication</em></li><li><em>13/05/2017 --- v1.1: Additional information about ways to defend and new patches added</em></li><li><em>15/05/2017 --- v1.2: Additional variants discovered and a new tool published</em></li><li><em>15/05/2017 --- v1.3: Some wording changed</em></li><li><em>16/05/2017 --- v1.4: Additional variants with new killswitches discovered</em></li><li><em>18/05/2017 --- v1.5: Encryption key recovery sometimes possible</em></li><li><em>22/05/2017 --- v1.6: Better tool available for recovering encrypted files; other campaigns identified</em></li></ul><h2 id=\"summary\">Summary</h2><p>A large ransomware campaign has been observed since Friday, May 12th, 2017. The payload delivered is a variant of ransomware malware called <strong>WannaCry</strong>. It appears to infect computers through a recent SMB vulnerability in Microsoft Windows operating system [1, 2, 3, 7, 12, 13] (CVE-2017-0145).</p><p>The exploit used -- <em>EternalBlue</em> -- has been made available on the Internet through the <em>ShadowBrokers</em> dump on April 14th, 2017 [6], but already earlier patched by Microsoft on March 14th, 2017 as part of MS17-010 [3] for the supported versions of the Microsoft Windows operating system. Unfortunately, the patch was not available at that time for legacy Windows XP, Windows 8, as well as for Windows Server 2003 systems. Even in case of systems where the patch was available, it appears that many organizations have not installed it. There were more than 200 000 computers affected world-wide with some prominent organizations including Telefonica [4] in Spain and NHS hospitals in UK [5].</p><p>As of May 13th, 2017, due to the seriousness of the threat, <strong>Microsoft has made available the patch MS17-010</strong> [9] also for earlier (no longer supported) versions of Microsoft Windows operating system, such as <strong>Windows XP</strong>, <strong>Windows 8</strong>, and <strong>Windows Server 2003</strong>.</p><p>A tool called <em><strong>wanakiwi</strong></em> has been recently made available that <strong>may make it possible to recover the encrypted files</strong> on Windows XP, Windows 7, Windows Vista, Windows Server 2003 and 2008, if the system was not rebooted after the infection [16].</p><p>Other campaigns leveraging the tools leaked by the <em>ShadowBrokers</em> have been identified [18, 19]. While they do not deliver ransomware, they may be used for other purposes and represent a significant threat. The other campaigns share the same infection method -- SMB. It is important to monitor network activity even if no ransomware cases have been observed.</p><h2 id=\"technical-details\">Technical Details</h2><p>The campaign uses an exploit for a recent SMB protocol vulnerability in Microsoft Windows [1, 2, 3, 7]. According to [7], the ransomware perpetrators incorporated publicly-available exploit code for the patched SMB <em>EternalBlue</em> vulnerability, CVE-2017-0145, which can be triggered by sending a specially crafted packet to a targeted SMB server. It spreads initially through vulnerable computers exposing port 445 on the Internet, and then using the same technique propagating through the internal network.</p><p>Following [7], the threat arrives as a dropper that has the following two components:</p><ul><li>A component that tries to exploit the SMB <em>EternalBlue</em> vulnerability in other computers.</li><li>Ransomware known as <em>WannaCry</em>/<em>WannaCrypt</em>.</li></ul><p>The dropper -- depending on the version -- tries to connect to one of the following (<em>killswitch</em>) domains [7, 8, 10, 14]:</p><pre><code>iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com\nifferfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com\nayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf[.]com\nlazarusse.suiche.sdfjhgosurijfaqwqwqrgwea[.]com\n</code></pre><p>These domains have been <strong>sinkholed</strong> by MalwareTech [8] and others. <strong>If the connection is successful</strong>, the threat <strong>does not infect</strong> the system further with ransomware or try to exploit other systems to spread; it simply stops execution. However, if the connection fails, the dropper proceeds to drop the ransomware and creates a service on the system. Hence, it is imperative to <strong>enable access to this domain</strong>, by either:</p><ul><li>enabling access to this domain on the Internet -- the malware is not proxy-aware, so if a proxy use is required, this may fail;</li><li>redirecting the requests to this domain (through local DNS or proxy re-writing, etc.) to a webserver that will respond with HTTP code 200 to any request.</li></ul><p>In either case, it is worth to <strong>monitor the requests</strong> as the machines initiating these requests most likely had been infected with the WannaCray ransomware.</p><p>The threat creates a service named <code>mssecsvc2.0</code>, whose function is to exploit the SMB vulnerability in other computers accessible from the infected system. Once at least one computer in local network is infected, the malware will automatically spread using the SMB protocol on TCP port 445 [7]. It is important to mention that <strong>unpatched</strong> computers and networks exposing SMB protocol on the Internet may be directly infected without the need for any other delivery mechanism. It is sufficient that they are powered-up and accepting SMB protocol connections. Recent analysis [12, 13] also indicates that if a target system is infected with <em>DoublePulsar</em> backdoor, it will be automatically exploited. Also, once a new system is infected, <em>DoublePulsar</em> will be installed as well.</p><p>The malware used in the attacks encrypts the files and also drops and executes a decryptor tool. Then, the malware requests around $300 in Bitcoin for obtaining a decryption key. The decryption tool clearly supports multiple countries, as it provides the interface in several languages. For command and control, the malware extracts and uses Tor service executable with all necessary dependencies to access the Tor network. More analysis may be found in [2] and [7].</p><p>The file extensions that the malware is targeting contain certain clusters of formats including [2]:</p><ul><li>Commonly used office file extensions (<code>.ppt</code>, <code>.doc</code>, <code>.docx</code>, <code>.xlsx</code>, <code>.sxi</code>).</li><li>Less common and nation-specific office formats (<code>.sxw</code>, <code>.odt</code>, <code>.hwp</code>).</li><li>Archives, media files (<code>.zip</code>, <code>.rar</code>, <code>.tar</code>, <code>.bz2</code>, <code>.mp4</code>, <code>.mkv</code>).</li><li>Emails and email databases (<code>.eml</code>, <code>.msg</code>, <code>.ost</code>, <code>.pst</code>, <code>.edb</code>).</li><li>Database files (<code>.sql</code>, <code>.accdb</code>, <code>.mdb</code>, <code>.dbf</code>, <code>.odb</code>, <code>.myd</code>).</li><li>Developers’ sourcecode and project files (<code>.php</code>, <code>.java</code>, <code>.cpp</code>, <code>.pas</code>, <code>.asm</code>).</li><li>Encryption keys and certificates (<code>.key</code>, <code>.pfx</code>, <code>.pem</code>, <code>.p12</code>, <code>.csr</code>, <code>.gpg</code>, <code>.aes</code>).</li><li>Graphic designers, artists and photographers files (<code>.vsd</code>, <code>.odg</code>, <code>.raw</code>, <code>.nef</code>, <code>.svg</code>, <code>.psd</code>).</li><li>Virtual machine files (<code>.vmx</code>, <code>.vmdk</code>, <code>.vdi</code>).</li></ul><h3 id=\"other-related-campaigns\">Other Related Campaigns</h3><p>Since the start of the <em>WannaCry</em> campaign, there has been a lot of interest and research performed. This allowed to also identify other campaigns exploiting the vulnerabilities published by the <em>ShadowBrokers</em>, such as <em>BlueDoom</em> [18] or <em>EternalRocks</em> [19], and others. Some of these campaigns have started prior to the <em>WannaCry</em>, and other later. They all share the same infection vector, but the differ in the activity performed after infection. Some are used to mine <em>Monero</em> cryptocurrency, others install backdoors that could be used later, but do not perform any additional visible actions for the moment. Most of these additional campaigns do not use any type of <em>killswitch</em>.</p><p>Since the initial infection for all these related campaigns appears to be using the same infection vector, it is important to monitor networks for activity related to <em>EternalBlue</em> even if no ransomware infections have been observed. There may be machines infected with any of the other campaigns. The following SNORT rules may be used to detect network activity related to <em>EternalBlue</em> [17]:</p><pre><code>alert tcp $HOME_NET 445 -&gt; any any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response”; flow:from_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:2;)\n\nalert smb any any -&gt; $HOME_NET any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Request (set)”; flow:to_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 18 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:set,ETPRO.ETERNALBLUE; flowbits:noalert; classtype:trojan-activity; sid:2024220; rev:1;)\n\nalert smb $HOME_NET any -&gt; any any (msg:”ET EXPLOIT Possible ETERNALBLUE MS17-010 Echo Response”; flow:from_server,established; content:”|00 00 00 31 ff|SMB|2b 00 00 00 00 98 07 c0|”; depth:16; fast_pattern; content:”|4a 6c 4a 6d 49 68 43 6c 42 73 72 00|”; distance:0; flowbits:isset,ETPRO.ETERNALBLUE; classtype:trojan-activity; sid:2024218; rev:1;)\n</code></pre><h2 id=\"products-affected\">Products Affected</h2><p>The following products known to be impacted if they are not patched [1, 3, 7]:</p><ul><li>Microsoft Windows Vista SP2</li><li>Microsoft Windows Server 2008 SP2 and R2 SP1</li><li>Microsoft Windows 7</li><li>Microsoft Windows 8.1</li><li>Microsoft Windows RT 8.1</li><li>Microsoft Windows Server 2012 and R2</li></ul><p>It has been recently confirmed [7] that the malware targets also earlier -- no longer supported -- version of the Microsoft operating system:</p><ul><li>Windows XP</li><li>Windows 8</li><li>Windows Server 2003</li></ul><p>At the same time, Microsoft has confirmed [7] that Windows 10 is not impacted by this attack at the moment. It is important to realize however that the attack may evolve and future versions may also target unpatched versions of Windows 10.</p><h2 id=\"recommendations\">Recommendations</h2><p>A patch for the SMB vulnerability is available as Microsoft Security Bulletin <strong>MS17-010</strong> for the supported Microsoft Windows operating system versions [3]. It is imperative that this patch is installed. Since the threat appears to evolve (new variants, new <em>killswitch</em> domains appearing), any measures relying on a specific characteristic of the variants currently used, should not be considered reliable.</p><p>Additionally, as of May 13th, 2017, due to the seriousness of the threat, <strong>Microsoft has made available the patch MS17-010</strong> [9] also for earlier (no longer supported) versions of Microsoft Windows operating system, such as <strong>Windows XP</strong>, <strong>Windows 8</strong>, and <strong>Windows Server 2003</strong>.</p><p>Additionally, the following measures should be taken as soon as possible [1, 7]:</p><ul><li>Update system with Microsoft patch MS17-010 or upgrade to Windows 10.</li><li>Disable SMBv1 with the steps documented at Microsoft Knowledge Base Article 2696547.</li><li>Consider adding a rule on the firewall to block incoming SMB traffic on port 445.</li><li>Discover which systems within the network may be susceptible to attack and isolate them, update, and/or shut down.</li><li>For systems without support or patch available, it is recommended to isolate them from the network or shut down as the case may be. As an option, there has been a tool published [11], which can block execution of the malware on vulnerable systems.</li><li>In case of new infections, it is highly recommended to provide all workstations with access to the <em>killswitch</em> domains as mentioned in the [Technical Details] section of this advisory.</li></ul><p>As a general rule, the best defense against ransomware-type attacks are frequent and reliable backups. If a recent backup is available, the affected systems may be easily restored from backups.</p><p>In case of infection/encryption of files, there may be a possibility to <strong>recover the encrypted files</strong> on Windows XP, Windows 7, Windows Vista, Windows Server 2003 and 2008, if the system was not rebooted after the infection [16]. The <em>wanakiwi</em> tool tries to recover the private user key in memory by searching for the two prime numbers used to generate the RSA key-pair during the WannaCry encryption process. The primes extraction method is based on Adrien Guinet's <em>wannakey</em> [15], which consist of scanning the WannaCry process memory to recover the prime numbers that were not cleaned during <code>CryptReleaseContext()</code>.</p><p>Also, it should be kept in mind that making the ransomware payment does not guarantee that the attackers send the decryption key. Currently, there are no confirmed cases for this campaign indicating that paying the ransom actually allowed to decrypt the files.</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.ccn-cert.cni.es/seguridad-al-dia/comunicados-ccn-cert/4464-ataque-masivo-de-ransomware-que-afecta-a-un-elevado-numero-de-organizaciones-espanolas.html\">https://www.ccn-cert.cni.es/seguridad-al-dia/comunicados-ccn-cert/4464-ataque-masivo-de-ransomware-que-afecta-a-un-elevado-numero-de-organizaciones-espanolas.html</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://securelist.com/blog/incidents/78351/wannacry-ransomware-used-in-widespread-attacks-all-over-the-world/\">https://securelist.com/blog/incidents/78351/wannacry-ransomware-used-in-widespread-attacks-all-over-the-world/</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://technet.microsoft.com/en-us/library/security/ms17-010.aspx\">https://technet.microsoft.com/en-us/library/security/ms17-010.aspx</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.gdatasoftware.com/2017/05/29751-wannacry-ransomware-campaign\">https://blog.gdatasoftware.com/2017/05/29751-wannacry-ransomware-campaign</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://krebsonsecurity.com/2017/05/u-k-hospitals-hit-in-widespread-ransomware-attack/\">https://krebsonsecurity.com/2017/05/u-k-hospitals-hit-in-widespread-ransomware-attack/</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://support.kaspersky.com/shadowbrokers\">https://support.kaspersky.com/shadowbrokers</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://blogs.technet.microsoft.com/mmpc/2017/05/12/wannacrypt-ransomware-worm-targets-out-of-date-systems/\">https://blogs.technet.microsoft.com/mmpc/2017/05/12/wannacrypt-ransomware-worm-targets-out-of-date-systems/</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://intel.malwaretech.com/botnet/wcrypt\">https://intel.malwaretech.com/botnet/wcrypt</a></p><p>[9] <a rel=\"noopener\" target=\"_blank\" href=\"https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/\">https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/</a></p><p>[10] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e\">https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e</a></p><p>[11] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.ccn-cert.cni.es/en/updated-security/ccn-cert-statements/4485-nomorecry-tool-ccn-cert-s-tool-to-prevent-the-execution-of-the-ransomware-wannacry.html\">https://www.ccn-cert.cni.es/en/updated-security/ccn-cert-statements/4485-nomorecry-tool-ccn-cert-s-tool-to-prevent-the-execution-of-the-ransomware-wannacry.html</a></p><p>[12] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.malwarebytes.com/threat-analysis/2017/05/the-worm-that-spreads-wanacrypt0r/\">https://blog.malwarebytes.com/threat-analysis/2017/05/the-worm-that-spreads-wanacrypt0r/</a></p><p>[13] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.endgame.com/blog/wcrywanacry-ransomware-technical-analysis\">https://www.endgame.com/blog/wcrywanacry-ransomware-technical-analysis</a></p><p>[14] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/security/wannacry-wana-decryptor-wanacrypt0r-info-and-technical-nose-dive/\">https://www.bleepingcomputer.com/news/security/wannacry-wana-decryptor-wanacrypt0r-info-and-technical-nose-dive/</a></p><p>[15] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/aguinet/wannakey\">https://github.com/aguinet/wannakey</a></p><p>[16] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/gentilkiwi/wanakiwi\">https://github.com/gentilkiwi/wanakiwi</a></p><p>[17] <a rel=\"noopener\" target=\"_blank\" href=\"https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/\">https://securingtomorrow.mcafee.com/executive-perspectives/analysis-wannacry-ransomware-outbreak/</a></p><p>[18] <a rel=\"noopener\" target=\"_blank\" href=\"https://heimdalsecurity.com/blog/bluedoom-worm-eternablue-nsa-exploits/\">https://heimdalsecurity.com/blog/bluedoom-worm-eternablue-nsa-exploits/</a></p><p>[19] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/security/new-smb-worm-uses-seven-nsa-hacking-tools-wannacry-used-just-two/\">https://www.bleepingcomputer.com/news/security/new-smb-worm-uses-seven-nsa-hacking-tools-wannacry-used-just-two/</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  }
}