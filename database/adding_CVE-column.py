import json
import re
from pathlib import Path
from collections import Counter

ROOT = Path("certeu_dump")
CVE_REGEX = re.compile(r"(?i)\bCVE-\d{4}-\d{4,7}\b")

total_files = 0
files_with_cve = 0
total_cves = 0

# Track data quality problems
none_stats = Counter()


def extract_cves(data):
    text = " ".join([
        data.get("description") or "",
        data.get("content_markdown") or "",
        data.get("content_html") or "",
    ])
    return sorted(set(c.upper() for c in CVE_REGEX.findall(text)))


for file in ROOT.rglob("*.json"):
    total_files += 1

    try:
        data = json.loads(file.read_text(encoding="utf-8"))
    except Exception as e:
        print(f"[!] error reading {file}: {e}")
        continue

    # ðŸ“Š check which columns are None / missing
    for field in ["description", "content_markdown", "content_html"]:
        if not data.get(field):
            none_stats[field] += 1

    # ðŸ”Ž extract CVEs
    cves = extract_cves(data)

    if cves:
        files_with_cve += 1
        total_cves += len(cves)

    # âœï¸ always write the column for schema consistency
    data["cves"] = cves

    file.write_text(
        json.dumps(data, indent=2, ensure_ascii=False),
        encoding="utf-8"
    )

    print(f"[+] {file} -> {len(cves)} CVE")


# ======================
# FINAL STATS
# ======================

percentage_with = (files_with_cve / total_files * 100) if total_files else 0
percentage_without = 100 - percentage_with


print("\n========== SUMMARY ==========")
print("files scanned        :", total_files)
print("files with CVE       :", files_with_cve)
print("files without CVE    :", total_files - files_with_cve)
print("total CVE references :", total_cves)
print("percentage with CVE  : {:.2f}%".format(percentage_with))
print("percentage without   : {:.2f}%".format(percentage_without))

print("\n====== MISSING DATA ======")
for field, count in none_stats.items():
    pct = count / total_files * 100
    print(f"{field:20} : {count} files ({pct:.2f}%)")
