{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2018-024.pdf"
  },
  "title": "Windows Task Scheduler â€“ Privileges Escalation Vulnerability",
  "serial_number": "2018-024",
  "publish_date": "30-08-2018 08:51:00",
  "description": "On August 27th, a tweet from a researcher with a nick SandboxEscaper announced an unpatched local privileges escalation vulnerability in Windows. This flaw is affecting the way Task Scheduler uses Advanced Local Procedure Call (ALPC) to read and set permissions. This allows a user with read access to an object to change his rights on it. Eventually, this vulnerability allows a user to run code with SYSTEM privileges. It is important to notice that a POC has been already<br>published on Internet and there is no available patch yet.",
  "url_title": "2018-024",
  "content_markdown": "---\ntitle: 'Windows Task Scheduler -- Privileges Escalation Vulnerability'\nversion: '1.0'\nnumber: '2018-024'\ndate: 'August 29, 2018'\n---\n\n_History:_\n\n* _29/08/2018 --- v1.0: Initial publication_\n\n# Summary\n\nOn August 27th, a tweet from a researcher with a nick _SandboxEscaper_ announced an unpatched local privileges escalation vulnerability in Windows. This flaw is affecting the way Task Scheduler uses Advanced Local Procedure Call (ALPC) to read and set permissions. This allows a user with read access to an object to change his rights on it. Eventually, this vulnerability allows a user to run code with SYSTEM privileges. It is important to notice that a POC has been already published on Internet and there is no available patch yet [1, 2].\n\n# Technical Details\n\nThe POC has been distributed with a text document giving some technical details about the exploit. This advisory is based on that [2].\n\nThe Windows Task Scheduler uses an ALPC method - `SchRpcSetSecurity` - to deal with the rights of the created tasks. As side effect, this function checks if a `.job` file exists under `c:\\windows\\tasks` and tries to set the permissions there too. Since all users have write permission there, an attacker can create a hard link in this folder in order to rewrite the privileges he has over other objects of the system. After that he can modify the object ending up with his code running as SYSTEM. This is the path followed by the POC with a DLL hijacking as outcome. It is important to note that this technique for rights rewriting could be used in other unforeseen ways.\n\n# Products Affected\n\nSo far we have checked the POC in a Windows 10 64-bits machine. The POC might need some patching to work in 32 bits, because it has some hard-coded paths. It is supposed also to affect Windows Server 2016.\n\n# Recommendations\n\nAt the date of issuing this advisory there is no patch available for this vulnerability from Microsoft.\n\n## Workarounds\n\nSince there is no patch available, CERT-EU has been searching for detection methods that could be deployed through different infrastructures.\n\nIt is important to note that to get benefits from this method, the proper policies - such as enabling audit on file change [5] - have to be set in the final systems.\n\nAs before mentioned, in order to use this exploit, a `.job` file in the folder `c:\\windows\\tasks` needs to be created. This event cannot be easily monitored with event log [6]. Anyway, there are other methods that can be used such as Sysmon event 11, a PowerShell script, or specific programs [7, 8].\n\nSubsequently, we have observed that a security event 4664 was recorded in the Windows event log when the hard link is created to link the `.job` file with the targeted object. As can be seen:\n\n```\n 4664\n\n An attempt was made to create a hard link.\n\n Subject:\n\tAccount Name:\t\tDESKTOP\\username\n\tAccount Name:\t\tusername\n\tAccount Domain:\t\tDESKTOP\n\tLogon ID:\t\t0x2190D\n\n Link Information:\n\tFile Name:\tC:\\Windows\\System32\\DriverStore\\FileRepository\\prnms003.inf_amd64_be4393c143e46548\\Amd64\\PrintConfig.dll\n\tLink Name:\tC:\\Windows\\Tasks\\UpdateTask.job\n\tTransaction ID:\t{00000000-0000-0000-0000-000000000000}\n```\n\nFinally, we have observed that a security event 4670 was created when rights are changed on the `.job`, being changed also in the same way via the hard link in the targeted object. As can be seen:\n\n```\n4670\n\nPermissions on an object were changed.\n\nSubject:\n\tSecurity ID:\t\tSYSTEM\n\tAccount Name:\t\tDESKTOP$\n\tAccount Domain:\t\tWORKGROUP\n\tLogon ID:\t\t0x3E7\n\nObject:\n\tObject Server:\tSecurity\n\tObject Type:\tFile\n\tObject Name:\tC:\\Windows\\Tasks\\UpdateTask.job\n\tHandle ID:\t0x198c\n\nProcess:\n\tProcess ID:\t0x3f4\n\tProcess Name:\tC:\\Windows\\System32\\svchost.exe\n\nPermissions Change:\n\tOriginal Security Descriptor:\tD:PAI(A;;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;;0x1200a9;;;BA)(A;;FA;;;SY)(A;;0x1200a9;;;BU)(A;;0x1200a9;;;AC)\n\tNew Security Descriptor:\tD:ARAI(A;;FA;;;BA)(A;;FA;;;SY)(A;;0x1301bf;;;AU)(A;;0x1200a9;;;BU)(A;ID;FA;;;BA)(A;ID;FA;;;SY)(A;ID;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)\n```\n\nAlthough, some of these events might be noisy, targeted searches through the events collected in a SIEM taking into account the path for for the `.job` files and the time window for the events can lead in a straightforward detection process. CERT-EU is implementing these searches across the logs available.\n\n**Note:** This is a temporary workaround. The final solution of course will be patching properly the system once the patch is available from Microsoft.\n\n# Exploits\n\nAs already mentioned there is an PoC exploit available in the wild [2].\n\n# References\n\n[1] <https://twitter.com/SandboxEscaper/status/1034125195148255235?ref_src=twsrc%5Etfw>\n\n[2] <https://github.com/SandboxEscaper/randomrepo/blob/master/PoC-LPE.rar>\n\n[3] <https://cwiki.apache.org/confluence/display/WW/S2-057>\n\n[4] <https://doublepulsar.com/task-scheduler-alpc-exploit-high-level-analysis-ff08cda6ad4f>\n\n[5] <https://www.ultimatewindowssecurity.com/blog/default.aspx?p=64d64d65-de9d-47d1-ac83-c7fb9fa0ebb2>\n\n[6] <https://blog.varonis.com/windows-file-activity-monitoring-event-log/>\n\n[7] <https://superuser.com/questions/226828/how-to-monitor-a-folder-and-trigger-a-command-line-action-when-a-file-is-created>\n\n[8] <https://www.nirsoft.net/utils/folder_changes_view.html>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>29/08/2018 --- v1.0: Initial publication</em></li></ul><h2 id=\"summary\">Summary</h2><p>On August 27th, a tweet from a researcher with a nick <em>SandboxEscaper</em> announced an unpatched local privileges escalation vulnerability in Windows. This flaw is affecting the way Task Scheduler uses Advanced Local Procedure Call (ALPC) to read and set permissions. This allows a user with read access to an object to change his rights on it. Eventually, this vulnerability allows a user to run code with SYSTEM privileges. It is important to notice that a POC has been already published on Internet and there is no available patch yet [1, 2].</p><h2 id=\"technical-details\">Technical Details</h2><p>The POC has been distributed with a text document giving some technical details about the exploit. This advisory is based on that [2].</p><p>The Windows Task Scheduler uses an ALPC method - <code>SchRpcSetSecurity</code> - to deal with the rights of the created tasks. As side effect, this function checks if a <code>.job</code> file exists under <code>c:\\windows\\tasks</code> and tries to set the permissions there too. Since all users have write permission there, an attacker can create a hard link in this folder in order to rewrite the privileges he has over other objects of the system. After that he can modify the object ending up with his code running as SYSTEM. This is the path followed by the POC with a DLL hijacking as outcome. It is important to note that this technique for rights rewriting could be used in other unforeseen ways.</p><h2 id=\"products-affected\">Products Affected</h2><p>So far we have checked the POC in a Windows 10 64-bits machine. The POC might need some patching to work in 32 bits, because it has some hard-coded paths. It is supposed also to affect Windows Server 2016.</p><h2 id=\"recommendations\">Recommendations</h2><p>At the date of issuing this advisory there is no patch available for this vulnerability from Microsoft.</p><h3 id=\"workarounds\">Workarounds</h3><p>Since there is no patch available, CERT-EU has been searching for detection methods that could be deployed through different infrastructures.</p><p>It is important to note that to get benefits from this method, the proper policies - such as enabling audit on file change [5] - have to be set in the final systems.</p><p>As before mentioned, in order to use this exploit, a <code>.job</code> file in the folder <code>c:\\windows\\tasks</code> needs to be created. This event cannot be easily monitored with event log [6]. Anyway, there are other methods that can be used such as Sysmon event 11, a PowerShell script, or specific programs [7, 8].</p><p>Subsequently, we have observed that a security event 4664 was recorded in the Windows event log when the hard link is created to link the <code>.job</code> file with the targeted object. As can be seen:</p><pre><code>4664\n\n An attempt was made to create a hard link.\n\n Subject:\n    Account Name:       DESKTOP\\username\n    Account Name:       username\n    Account Domain:     DESKTOP\n    Logon ID:       0x2190D\n\n Link Information:\n    File Name:  C:\\Windows\\System32\\DriverStore\\FileRepository\\prnms003.inf_amd64_be4393c143e46548\\Amd64\\PrintConfig.dll\n    Link Name:  C:\\Windows\\Tasks\\UpdateTask.job\n    Transaction ID: {00000000-0000-0000-0000-000000000000}\n</code></pre><p>Finally, we have observed that a security event 4670 was created when rights are changed on the <code>.job</code>, being changed also in the same way via the hard link in the targeted object. As can be seen:</p><pre><code>4670\n\nPermissions on an object were changed.\n\nSubject:\n    Security ID:        SYSTEM\n    Account Name:       DESKTOP$\n    Account Domain:     WORKGROUP\n    Logon ID:       0x3E7\n\nObject:\n    Object Server:  Security\n    Object Type:    File\n    Object Name:    C:\\Windows\\Tasks\\UpdateTask.job\n    Handle ID:  0x198c\n\nProcess:\n    Process ID: 0x3f4\n    Process Name:   C:\\Windows\\System32\\svchost.exe\n\nPermissions Change:\n    Original Security Descriptor:   D:PAI(A;;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)(A;;0x1200a9;;;BA)(A;;FA;;;SY)(A;;0x1200a9;;;BU)(A;;0x1200a9;;;AC)\n    New Security Descriptor:    D:ARAI(A;;FA;;;BA)(A;;FA;;;SY)(A;;0x1301bf;;;AU)(A;;0x1200a9;;;BU)(A;ID;FA;;;BA)(A;ID;FA;;;SY)(A;ID;FA;;;S-1-5-80-956008885-3418522649-1831038044-1853292631-2271478464)\n</code></pre><p>Although, some of these events might be noisy, targeted searches through the events collected in a SIEM taking into account the path for for the <code>.job</code> files and the time window for the events can lead in a straightforward detection process. CERT-EU is implementing these searches across the logs available.</p><p><strong>Note:</strong> This is a temporary workaround. The final solution of course will be patching properly the system once the patch is available from Microsoft.</p><h2 id=\"exploits\">Exploits</h2><p>As already mentioned there is an PoC exploit available in the wild [2].</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/SandboxEscaper/status/1034125195148255235?ref_src=twsrc%5Etfw\">https://twitter.com/SandboxEscaper/status/1034125195148255235?ref_src=twsrc%5Etfw</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/SandboxEscaper/randomrepo/blob/master/PoC-LPE.rar\">https://github.com/SandboxEscaper/randomrepo/blob/master/PoC-LPE.rar</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://cwiki.apache.org/confluence/display/WW/S2-057\">https://cwiki.apache.org/confluence/display/WW/S2-057</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://doublepulsar.com/task-scheduler-alpc-exploit-high-level-analysis-ff08cda6ad4f\">https://doublepulsar.com/task-scheduler-alpc-exploit-high-level-analysis-ff08cda6ad4f</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.ultimatewindowssecurity.com/blog/default.aspx?p=64d64d65-de9d-47d1-ac83-c7fb9fa0ebb2\">https://www.ultimatewindowssecurity.com/blog/default.aspx?p=64d64d65-de9d-47d1-ac83-c7fb9fa0ebb2</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.varonis.com/windows-file-activity-monitoring-event-log/\">https://blog.varonis.com/windows-file-activity-monitoring-event-log/</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://superuser.com/questions/226828/how-to-monitor-a-folder-and-trigger-a-command-line-action-when-a-file-is-created\">https://superuser.com/questions/226828/how-to-monitor-a-folder-and-trigger-a-command-line-action-when-a-file-is-created</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.nirsoft.net/utils/folder_changes_view.html\">https://www.nirsoft.net/utils/folder_changes_view.html</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  },
  "cves": []
}