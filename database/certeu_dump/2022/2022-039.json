{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2022-039.pdf"
  },
  "title": "UPDATE: Follina Vulnerability in Microsoft Office Products",
  "serial_number": "2022-039",
  "publish_date": "30-05-2022 10:59:00",
  "description": "On the 29th of May 2022, the Nao_Sec team, an independent Cyber Security Research Team, discovered a malicious Office document shared on Virustotal. This document is using an unusual, but known scheme to infect its victims. The scheme was not detected as malicious by some EDR, like Microsoft Defender for Endpoint. This vulnerability could lead to code execution without the need of user interaction, as it does not involve macros, except if the \"Protected View\" mode is enabled and the \"Preview mode\" is disabled in Windows Explorer.<br>On the 30th of May 2022, Microsoft started to track this vulnerability identified \"CVE-2022-30190\" (aka Follina) with a severity score of 7.8 out of 10.<br>On the 14th of June 2022, Microsoft has released security updates as part of June Patch Tuesday. One of the fixes applies to this actively exploited vulnerability. This update does not prevent Microsoft Office tools from loading Windows protocol URI handlers without user interaction, but will instead block PowerShell injection and disable this attack vector.",
  "url_title": "2022-039",
  "content_markdown": "---\ntitle: 'Follina Vulnerability in Microsoft Office Products'\nversion: '1.3'\nnumber: '2022-039'\noriginal_date: 'May 29, 2022'\ndate: 'June 15, 2022'\n---\n\n_History:_\n\n* _30/05/2022 --- v1.0 -- Initial publication_\n* _31/05/2022 --- v1.1 -- Updated with new information available_\n* _02/06/2022 --- v1.2 -- Updated with new information available about `search-ms`_\n* _15/06/2022 --- v1.3 -- Updated with new information about Microsoft patch_\n\n# Summary\n\nOn the 29th of May 2022, the Nao_Sec team [1], an independent Cyber Security Research Team, discovered a malicious Office document shared on Virustotal [2]. This document is using an unusual, but known scheme [3] to infect its victims. The scheme was not detected as malicious by some EDR, like Microsoft Defender for Endpoint. This vulnerability could lead to code execution without the need of user interaction, as it does not involve macros, except if the `Protected View` mode is enabled and the `Preview mode` is disabled in Windows Explorer [4].\n\nOn the 30th of May 2022, Microsoft started to track this vulnerability identified `CVE-2022-30190` (aka Follina) with a severity score of 7.8 out of 10.\n\nOn the 14th of June 2022, Microsoft has released security updates as part of June Patch Tuesday. One of the fixes applies to this actively exploited vulnerability. This update does not prevent Microsoft Office tools from loading Windows protocol URI handlers without user interaction, but will instead block PowerShell injection and disable this attack vector [16].\n\n# Technical Details\n\nThe vulnerability is being exploited by using the `MSProtocol URI` scheme to load some code. Attackers could embed malicious links inside Microsoft Office documents, templates or emails beginning with `ms-msdt:` that will be loaded and executed afterward without user interaction - except if the `Protected View` mode is enabled and/or the `Preview mode` is disabled in Windows Explorer [5]. Nevertheless, converting the document to the RTF format could also bypass the `Protected View` feature.\n\nSecurity researchers have shown that it is possible to exploit this vulnerability with another `MSProtocol URI` scheme: `search-ms:`. Using this scheme, attackers would be able to automatically mount remote shares on a computer in order to trick the user into executing malware [14].\n\n# Affected Products\n\nThe flow is affecting all Windows version still receiving Security Updates [11].\n\n# Recommendations \n\nCERT-EU strongly recommends installing the last updates provided with June 2022 cumulative Windows Updates.\n\nEnabling `Protected View` and disabling `Preview Mode` is still recommended.\n\n## Monitoring\n\nCERT-EU highly recommends monitoring for suspicious behaviours of Microsoft Office products: the process `msdt.exe` should not be spawned by Office products like `words.exe`, `outlook.exe` and also `excel.exe`.\n\nSome researchers have released monitoring rules for various products:\n\n- Sigma [6]\n- Sentinel [7]\n- Defender [8]\n\n## Workarounds\n\n_Note: The workarounds described below are to be implemented if updating is not an option._\n\nAs a temporary workaround, Didier Stevens proposed to remove the `ms-msdt` handler in the registry hives. While this could prevent legitimate applications to work, it seems that there are not many applications using it [9]. Microsoft also provided this word around [13].\n\nThe same way as for the MSDT mitigation, it is possible to delete the `search-ms` protocol handler from the Windows Registry [15].\n\nIt is also possible to use the Attack Surface Reduction features to prevent Office applications from spawning child processes [10]. However, some legitimate line-of-business applications might also generate child processes for benign purposes and will be blocked if enabled.\n\n# References\n\n[1] <https://nao-sec.org/about>\n\n[2] <https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection>\n\n[3] <https://blog.syss.com/posts/abusing-ms-office-protos/>\n\n[4] <https://youtu.be/GybD70_rZDs>\n\n[5] <https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e>\n\n[6] <https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_msdt.yml>\n\n[7] <https://github.com/le0li9ht/Microsoft-Sentinel-Queries/blob/main/Detect-Follina-Exploitation.kql>\n\n[8] <https://github.com/GossiTheDog/ThreatHunting/blob/master/AdvancedHuntingQueries/Follina-Office.ahq>\n\n[9] <https://twitter.com/sans_isc/status/1531075423270051841?s=20&t=_NYOie6ydEbP4JT5zHVJ7A>\n\n[10] <https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#block-all-office-applications-from-creating-child-processes>\n\n[11] <https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190>\n\n[12] <https://twitter.com/wdormann/status/1531427345143320576>\n\n[13] <https://www.bleepingcomputer.com/news/microsoft/microsoft-shares-mitigation-for-office-zero-day-exploited-in-attacks/>\n\n[14] <https://twitter.com/hackerfantastic/status/1531789430922567681>\n\n[15] <https://www.bleepingcomputer.com/news/security/new-windows-search-zero-day-added-to-microsoft-protocol-nightmare/>\n\n[16] <https://www.bleepingcomputer.com/news/security/microsoft-patches-actively-exploited-follina-windows-zero-day/>",
  "content_html": "<p><em>History:</em></p><ul><li><em>30/05/2022 --- v1.0 -- Initial publication</em></li><li><em>31/05/2022 --- v1.1 -- Updated with new information available</em></li><li><em>02/06/2022 --- v1.2 -- Updated with new information available about <code>search-ms</code></em></li><li><em>15/06/2022 --- v1.3 -- Updated with new information about Microsoft patch</em></li></ul><h2 id=\"summary\">Summary</h2><p>On the 29th of May 2022, the Nao_Sec team [1], an independent Cyber Security Research Team, discovered a malicious Office document shared on Virustotal [2]. This document is using an unusual, but known scheme [3] to infect its victims. The scheme was not detected as malicious by some EDR, like Microsoft Defender for Endpoint. This vulnerability could lead to code execution without the need of user interaction, as it does not involve macros, except if the <code>Protected View</code> mode is enabled and the <code>Preview mode</code> is disabled in Windows Explorer [4].</p><p>On the 30th of May 2022, Microsoft started to track this vulnerability identified <code>CVE-2022-30190</code> (aka Follina) with a severity score of 7.8 out of 10.</p><p>On the 14th of June 2022, Microsoft has released security updates as part of June Patch Tuesday. One of the fixes applies to this actively exploited vulnerability. This update does not prevent Microsoft Office tools from loading Windows protocol URI handlers without user interaction, but will instead block PowerShell injection and disable this attack vector [16].</p><h2 id=\"technical-details\">Technical Details</h2><p>The vulnerability is being exploited by using the <code>MSProtocol URI</code> scheme to load some code. Attackers could embed malicious links inside Microsoft Office documents, templates or emails beginning with <code>ms-msdt:</code> that will be loaded and executed afterward without user interaction - except if the <code>Protected View</code> mode is enabled and/or the <code>Preview mode</code> is disabled in Windows Explorer [5]. Nevertheless, converting the document to the RTF format could also bypass the <code>Protected View</code> feature.</p><p>Security researchers have shown that it is possible to exploit this vulnerability with another <code>MSProtocol URI</code> scheme: <code>search-ms:</code>. Using this scheme, attackers would be able to automatically mount remote shares on a computer in order to trick the user into executing malware [14].</p><h2 id=\"affected-products\">Affected Products</h2><p>The flow is affecting all Windows version still receiving Security Updates [11].</p><h2 id=\"recommendations\">Recommendations</h2><p>CERT-EU strongly recommends installing the last updates provided with June 2022 cumulative Windows Updates.</p><p>Enabling <code>Protected View</code> and disabling <code>Preview Mode</code> is still recommended.</p><h3 id=\"monitoring\">Monitoring</h3><p>CERT-EU highly recommends monitoring for suspicious behaviours of Microsoft Office products: the process <code>msdt.exe</code> should not be spawned by Office products like <code>words.exe</code>, <code>outlook.exe</code> and also <code>excel.exe</code>.</p><p>Some researchers have released monitoring rules for various products:</p><ul><li>Sigma [6]</li><li>Sentinel [7]</li><li>Defender [8]</li></ul><h3 id=\"workarounds\">Workarounds</h3><p><em>Note: The workarounds described below are to be implemented if updating is not an option.</em></p><p>As a temporary workaround, Didier Stevens proposed to remove the <code>ms-msdt</code> handler in the registry hives. While this could prevent legitimate applications to work, it seems that there are not many applications using it [9]. Microsoft also provided this word around [13].</p><p>The same way as for the MSDT mitigation, it is possible to delete the <code>search-ms</code> protocol handler from the Windows Registry [15].</p><p>It is also possible to use the Attack Surface Reduction features to prevent Office applications from spawning child processes [10]. However, some legitimate line-of-business applications might also generate child processes for benign purposes and will be blocked if enabled.</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://nao-sec.org/about\">https://nao-sec.org/about</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection\">https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://blog.syss.com/posts/abusing-ms-office-protos/\">https://blog.syss.com/posts/abusing-ms-office-protos/</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://youtu.be/GybD70_rZDs\">https://youtu.be/GybD70_rZDs</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e\">https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_msdt.yml\">https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_msdt.yml</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/le0li9ht/Microsoft-Sentinel-Queries/blob/main/Detect-Follina-Exploitation.kql\">https://github.com/le0li9ht/Microsoft-Sentinel-Queries/blob/main/Detect-Follina-Exploitation.kql</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/GossiTheDog/ThreatHunting/blob/master/AdvancedHuntingQueries/Follina-Office.ahq\">https://github.com/GossiTheDog/ThreatHunting/blob/master/AdvancedHuntingQueries/Follina-Office.ahq</a></p><p>[9] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/sans_isc/status/1531075423270051841?s=20&t=_NYOie6ydEbP4JT5zHVJ7A\">https://twitter.com/sans_isc/status/1531075423270051841?s=20&amp;t=_NYOie6ydEbP4JT5zHVJ7A</a></p><p>[10] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#block-all-office-applications-from-creating-child-processes\">https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/attack-surface-reduction-rules-reference?view=o365-worldwide#block-all-office-applications-from-creating-child-processes</a></p><p>[11] <a rel=\"noopener\" target=\"_blank\" href=\"https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190\">https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2022-30190</a></p><p>[12] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/wdormann/status/1531427345143320576\">https://twitter.com/wdormann/status/1531427345143320576</a></p><p>[13] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/microsoft/microsoft-shares-mitigation-for-office-zero-day-exploited-in-attacks/\">https://www.bleepingcomputer.com/news/microsoft/microsoft-shares-mitigation-for-office-zero-day-exploited-in-attacks/</a></p><p>[14] <a rel=\"noopener\" target=\"_blank\" href=\"https://twitter.com/hackerfantastic/status/1531789430922567681\">https://twitter.com/hackerfantastic/status/1531789430922567681</a></p><p>[15] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/security/new-windows-search-zero-day-added-to-microsoft-protocol-nightmare/\">https://www.bleepingcomputer.com/news/security/new-windows-search-zero-day-added-to-microsoft-protocol-nightmare/</a></p><p>[16] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.bleepingcomputer.com/news/security/microsoft-patches-actively-exploited-follina-windows-zero-day/\">https://www.bleepingcomputer.com/news/security/microsoft-patches-actively-exploited-follina-windows-zero-day/</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  },
  "cves": [
    "CVE-2022-30190"
  ]
}