{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2019-002.pdf"
  },
  "title": "Privilege Escalation Exploiting MS Exchange",
  "serial_number": "2019-002",
  "publish_date": "31-01-2019 14:32:00",
  "description": "A vulnerability was discovered in Microsoft Exchange Server that allows a regular user to perform a privilege escalation technique and gain Domain Administrator access. Abusing the privileged role Exchange servers normally have by default on Active Directory (AD) infrastructures, an attacker can impersonate a mail server, perform an NTLM relay attack, and gain access to the Domain Controllers secrets (e.g. NTLM hashes and Kerberos keys).",
  "url_title": "2019-002",
  "content_markdown": "---\ntitle: 'Privilege Escalation Exploiting MSÂ Exchange'\nversion: '1.0'\nnumber: '2019-002'\ndate: 'January 31, 2019'\n---\n\n_History:_\n\n* _31/01/2019 --- v1.0 -- Initial publication_\n\n# Summary\n\nA vulnerability was discovered in Microsoft Exchange Server that allows a regular user to perform a privilege escalation technique and gain Domain Administrator access. Abusing the privileged role Exchange servers normally have by default on Active Directory (AD) infrastructures, an attacker can impersonate a mail server, perform an NTLM relay attack, and gain access to the Domain Controllers secrets (e.g. NTLM hashes and Kerberos keys).\n\n# Technical Details\n\nThis NTLM replay attack has been out in the wild for some time. In short, it allows privilege escalation. It is most commonly used over SMB, but it is also available over HTTP. More details can be found in an article written by Dirk-Jan Mollema [1]. The article explains how the attack can be performed using valid user credentials, or even without them. In the latter case, the attacker replays the authentication of an existing user in the same network segment as the Exchange server.\n\nAn attacker with access to a Microsoft Exchange mailbox can ask the considered server to send push notifications to an arbitrary URL that he or she controls. When sending an HTTP notification message to the requested location, Microsoft Exchange will authenticate itself by providing the server's NTLM hash. Using the latter, the attacker will be able to run an NTLM relay attack against one of the Domain Controllers, impersonating the Exchange Server. Abusing the privileged role the server normally has by default in Active Directory infrastructures (i.e. `WriteDacl` on the AD Domain object), the attacker will be able to grant the initial unprivileged user DCSync privileges (i.e. `Replicating Directory Changes` and `Replicating Directory Changes All`) and so the right to collect all the available NTLM hashes and Kerberos keys.\n\nThe tools `PrivExchange` [2] and `impacket` [3] that can be used for proof of concept are available on GitHub.\n\n# Versions Affected\n\nThe vulnerability has been proven in Microsoft Exchange 2013 (CU 21) on Windows Server 2012 R2 relayed to a Windows Server 2016 Domain Controller and on Microsoft Exchange 2016 (CU 11) on Windows Server 2016 relayed to a Windows Server 2019 Domain Controller (all fully patched) [1].\n\n# Recommendations\n\n## Mitigation\n\nHaving tested some of the mitigations proposed in [1], we have concluded that the following one works without any apparent adverse side-effects:\n\nIf Exchange Web Services (EWS) dynamic subscriptions [5] are not used in your organization, you can block the attack described in this advisory by **enforcing a limit of 0 subscriptions maximum on the EWS service across the whole Exchange organization**. This is done in the following way, according to [6]:\n\n\tNew-ThrottlingPolicy -Name AllUsersEWSPolicyNoSubscriptions -EwsMaxSubscriptions 0 -ThrottlingPolicyScope Organization\n\nIf immediate enforcement is critical, you can run the following command on every front-end server; if not, you can skip this second step:\n\n\tRestart-WebAppPool -Name MSExchangeServicesAppPool\n\n## Other Possible Mitigations\n\nAdditional mitigations are proposed in [1]. We have selected some and assessed their effectiveness. The results can be found below. For the sake of completeness, we also include some comments despite the fact they refer to solutions that have not been tested by us.\n\n### Tested\n\n- **Enable Extended Protection for Authentication on the Exchange endpoints in IIS.**\n\nThis is about enabling Extended Protection Authentication [7] on at least one endpoint of the Exchange front-end sites found in Internet Information Services (IIS). According to our research and proof-of-concept, enabling it on the Exchange Web Services (EWS) endpoint is enough to break the attack. Following [8], two configurations need to be set up for this to work:\n\n1. Create a Service Principal Name (SPN) for HTTP services running on the Exchange host machine;\n2. Update the Web Services Virtual Directory pointing to the EWS endpoint with the `ExtendedProtectionTokenChecking` attribute set to *Require* and the `ExtendedProtectionSPNList` attribute set to the SPN created before.\n\n```\nsetspn -s http/[Exchange Server FQDN]:[TCP Port] [Exchange Server NetBIOS]\nSet-WebServicesVirtualDirectory -Identity \"[Exchange Server NetBIOS]\\EWS (Default Web Site)\"\n    -ExtendedProtectionTokenChecking Require -ExtendedProtectionSPNList http/[Exchange Server FQDN]:[TCP Port]\n```\n\nComment: _Implementing this change has proven to break at least the results of the `Test-WebServicesConnectivity` cmdlet that performs a `GetFolder` test on the EWS Web Service endpoint. Implementing this change should be done with close monitoring of all Exchange services that are used._\n\n- **Remove the registry key which makes relaying back to the Exchange server possible, as discussed in Microsofts mitigation for CVE-2018-8518.**\n\nComment: _This does not seem to prevent the attack in our testing._\n\n### Not Tested\n\n- **Remove unnecessary privileges of Exchange to Domain**\n\nComment: _This recommendation is best targeted at organizations having access to Microsoft Support, as the special settings to setup Exchange with limited rights are not in the public domain and will very from version to version. Moreover, special care should be used to detect possible side effects on the various capabilities used in the Exchange architecture._\n\n- **Enable LDAP signing and channel binding.**\n\nComment: _Be aware of the possible side effects impacting non-Microsoft clients or older Microsoft operating systems in the ecosystem._\n\n- **Block connections on the Exchange level to arbitrary ports.**\n- **Enforce SMB signing on Exchange servers (and preferable all other servers and workstations in the domain) to prevent cross-protocol relay attacks to SMB.**\n\n# References\n\n[1] <https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/>\n\n[2] <https://github.com/dirkjanm/privexchange/>\n\n[3] <https://github.com/SecureAuthCorp/impacket/>\n\n[4] <https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8581>\n\n[5] <https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/notification-subscriptions-mailbox-events-and-ews-in-exchange>\n\n[6] <https://docs.microsoft.com/en-us/powershell/module/exchange/server-health-and-performance/new-throttlingpolicy?view=exchange-ps>\n\n[7] <https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-3.5/dd767318(v=vs.90)>\n\n[8] <https://docs.microsoft.com/en-us/powershell/module/exchange/client-access-servers/set-webservicesvirtualdirectory?view=exchange-ps>\n",
  "content_html": "<p><em>History:</em></p><ul><li><em>31/01/2019 --- v1.0 -- Initial publication</em></li></ul><h2 id=\"summary\">Summary</h2><p>A vulnerability was discovered in Microsoft Exchange Server that allows a regular user to perform a privilege escalation technique and gain Domain Administrator access. Abusing the privileged role Exchange servers normally have by default on Active Directory (AD) infrastructures, an attacker can impersonate a mail server, perform an NTLM relay attack, and gain access to the Domain Controllers secrets (e.g. NTLM hashes and Kerberos keys).</p><h2 id=\"technical-details\">Technical Details</h2><p>This NTLM replay attack has been out in the wild for some time. In short, it allows privilege escalation. It is most commonly used over SMB, but it is also available over HTTP. More details can be found in an article written by Dirk-Jan Mollema [1]. The article explains how the attack can be performed using valid user credentials, or even without them. In the latter case, the attacker replays the authentication of an existing user in the same network segment as the Exchange server.</p><p>An attacker with access to a Microsoft Exchange mailbox can ask the considered server to send push notifications to an arbitrary URL that he or she controls. When sending an HTTP notification message to the requested location, Microsoft Exchange will authenticate itself by providing the server's NTLM hash. Using the latter, the attacker will be able to run an NTLM relay attack against one of the Domain Controllers, impersonating the Exchange Server. Abusing the privileged role the server normally has by default in Active Directory infrastructures (i.e. <code>WriteDacl</code> on the AD Domain object), the attacker will be able to grant the initial unprivileged user DCSync privileges (i.e. <code>Replicating Directory Changes</code> and <code>Replicating Directory Changes All</code>) and so the right to collect all the available NTLM hashes and Kerberos keys.</p><p>The tools <code>PrivExchange</code> [2] and <code>impacket</code> [3] that can be used for proof of concept are available on GitHub.</p><h2 id=\"versions-affected\">Versions Affected</h2><p>The vulnerability has been proven in Microsoft Exchange 2013 (CU 21) on Windows Server 2012 R2 relayed to a Windows Server 2016 Domain Controller and on Microsoft Exchange 2016 (CU 11) on Windows Server 2016 relayed to a Windows Server 2019 Domain Controller (all fully patched) [1].</p><h2 id=\"recommendations\">Recommendations</h2><h3 id=\"mitigation\">Mitigation</h3><p>Having tested some of the mitigations proposed in [1], we have concluded that the following one works without any apparent adverse side-effects:</p><p>If Exchange Web Services (EWS) dynamic subscriptions [5] are not used in your organization, you can block the attack described in this advisory by <strong>enforcing a limit of 0 subscriptions maximum on the EWS service across the whole Exchange organization</strong>. This is done in the following way, according to [6]:</p><pre><code>New-ThrottlingPolicy -Name AllUsersEWSPolicyNoSubscriptions -EwsMaxSubscriptions 0 -ThrottlingPolicyScope Organization\n</code></pre><p>If immediate enforcement is critical, you can run the following command on every front-end server; if not, you can skip this second step:</p><pre><code>Restart-WebAppPool -Name MSExchangeServicesAppPool\n</code></pre><h3 id=\"other-possible-mitigations\">Other Possible Mitigations</h3><p>Additional mitigations are proposed in [1]. We have selected some and assessed their effectiveness. The results can be found below. For the sake of completeness, we also include some comments despite the fact they refer to solutions that have not been tested by us.</p><h4 id=\"tested\">Tested</h4><ul><li><strong>Enable Extended Protection for Authentication on the Exchange endpoints in IIS.</strong></li></ul><p>This is about enabling Extended Protection Authentication [7] on at least one endpoint of the Exchange front-end sites found in Internet Information Services (IIS). According to our research and proof-of-concept, enabling it on the Exchange Web Services (EWS) endpoint is enough to break the attack. Following [8], two configurations need to be set up for this to work:</p><ol><li>Create a Service Principal Name (SPN) for HTTP services running on the Exchange host machine;</li><li>Update the Web Services Virtual Directory pointing to the EWS endpoint with the <code>ExtendedProtectionTokenChecking</code> attribute set to <em>Require</em> and the <code>ExtendedProtectionSPNList</code> attribute set to the SPN created before.</li></ol><pre><code>setspn -s http/[Exchange Server FQDN]:[TCP Port] [Exchange Server NetBIOS]\nSet-WebServicesVirtualDirectory -Identity \"[Exchange Server NetBIOS]\\EWS (Default Web Site)\"\n    -ExtendedProtectionTokenChecking Require -ExtendedProtectionSPNList http/[Exchange Server FQDN]:[TCP Port]\n</code></pre><p>Comment: <em>Implementing this change has proven to break at least the results of the <code>Test-WebServicesConnectivity</code> cmdlet that performs a <code>GetFolder</code> test on the EWS Web Service endpoint. Implementing this change should be done with close monitoring of all Exchange services that are used.</em></p><ul><li><strong>Remove the registry key which makes relaying back to the Exchange server possible, as discussed in Microsofts mitigation for CVE-2018-8518.</strong></li></ul><p>Comment: <em>This does not seem to prevent the attack in our testing.</em></p><h4 id=\"not-tested\">Not Tested</h4><ul><li><strong>Remove unnecessary privileges of Exchange to Domain</strong></li></ul><p>Comment: <em>This recommendation is best targeted at organizations having access to Microsoft Support, as the special settings to setup Exchange with limited rights are not in the public domain and will very from version to version. Moreover, special care should be used to detect possible side effects on the various capabilities used in the Exchange architecture.</em></p><ul><li><strong>Enable LDAP signing and channel binding.</strong></li></ul><p>Comment: <em>Be aware of the possible side effects impacting non-Microsoft clients or older Microsoft operating systems in the ecosystem.</em></p><ul><li><strong>Block connections on the Exchange level to arbitrary ports.</strong></li><li><strong>Enforce SMB signing on Exchange servers (and preferable all other servers and workstations in the domain) to prevent cross-protocol relay attacks to SMB.</strong></li></ul><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/\">https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/dirkjanm/privexchange/\">https://github.com/dirkjanm/privexchange/</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/SecureAuthCorp/impacket/\">https://github.com/SecureAuthCorp/impacket/</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8581\">https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2018-8581</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/notification-subscriptions-mailbox-events-and-ews-in-exchange\">https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/notification-subscriptions-mailbox-events-and-ews-in-exchange</a></p><p>[6] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/powershell/module/exchange/server-health-and-performance/new-throttlingpolicy?view=exchange-ps\">https://docs.microsoft.com/en-us/powershell/module/exchange/server-health-and-performance/new-throttlingpolicy?view=exchange-ps</a></p><p>[7] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-3.5/dd767318(v=vs.90)\">https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-3.5/dd767318(v=vs.90)</a></p><p>[8] <a rel=\"noopener\" target=\"_blank\" href=\"https://docs.microsoft.com/en-us/powershell/module/exchange/client-access-servers/set-webservicesvirtualdirectory?view=exchange-ps\">https://docs.microsoft.com/en-us/powershell/module/exchange/client-access-servers/set-webservicesvirtualdirectory?view=exchange-ps</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  },
  "cves": [
    "CVE-2018-8518",
    "CVE-2018-8581"
  ]
}