{
  "file_item": {
    "filepath": "security-advisories",
    "filename": "CERT-EU-SA2023-075.pdf"
  },
  "title": "Citrix NetScaler Critical Vulnerability",
  "serial_number": "2023-075",
  "publish_date": "03-11-2023 10:52:14",
  "description": "On October 10, 2023, Citrix issued an advisory about multiple buffer-related vulnerabilities, CVE-2023-4966 and CVE-2023-4967, affecting NetScaler ADC and NetScaler Gateway. These vulnerabilities can result in sensitive information disclosure and denial of service attacks.<br>\nIt is recommended updating and remediating affected devices as soon as possible.<br>\nOn October 19, 2023, Mandiant issued a remediation report regarding the vulnerability CVE-2023-4966. Mandiant identified a zero-day exploitation of this vulnerability in the wild beginning in late August 2023.<br>\nOn October 25, 2023, AssetIO brought more details about the exploitation of CVE-2023-4966 giving opportunities to detect a possible exploitation of the vulnerability. However, this requires an HTTP frontend source (e.g., network probe, WAF or reverse proxy) before reaching the Citrix HTTP services. A proof-of-concept is also available for that vulnerability.<br>\n[UPDATE] On November 2, 2023, Mandiant shared information about artefacts that can be used to identify exploitation activity. Mandiant also shared their post exploitation techniques observation.<br>\n",
  "url_title": "2023-075",
  "content_markdown": "---\ntitle: 'Citrix NetScaler Critical Vulnerability'\nnumber: '2023-075'\nversion: '1.4'\noriginal_date: 'October 10, 2023'\ndate: 'October 10, 2023'\n---\n\n_History:_\n\n* _10/10/2023 --- v1.0 -- Initial publication_\n* _10/10/2023 --- v1.1 -- Fixed affected products list_\n* _19/10/2023 --- v1.2 -- Added remediation and investigation informations from Mandiant_\n* _26/10/2023 --- v1.3 -- Added additional remediation commands and detection informations_\n* _03/11/2023 --- v1.4 -- Added additional detection informations_\n\n# Summary\n\nOn October 10, 2023, Citrix issued an advisory about multiple buffer-related vulnerabilities, **CVE-2023-4966** and **CVE-2023-4967**, affecting NetScaler ADC and NetScaler Gateway. These vulnerabilities can result in sensitive information disclosure and denial of service attacks [1].\n\nIt is recommended updating and remediating affected devices **as soon as possible**.\n\nOn October 19, 2023, Mandiant issued a remediation report regarding the vulnerability **CVE-2023-4966** [2]. Mandiant identified a zero-day exploitation of this vulnerability in the wild beginning in late August 2023.\n\nOn October 25, 2023, AssetIO brought more details [3] about the exploitation of **CVE-2023-4966** giving opportunities to detect a possible exploitation of the vulnerability. However, this requires an HTTP frontend source (e.g., network probe, WAF or reverse proxy) before reaching the Citrix HTTP services. A proof-of-concept is also available for that vulnerability [4].\n\n**[UPDATE]** On November 2, 2023, Mandiant shared [5] information about artefacts that can be used to identify exploitation activity. Mandiant also shared their post exploitation techniques observation.\n\n# Technical Details\n\nThe vulnerability `CVE-2023-4966`, with as CVSS score of 9.4 out of 10, can lead to sensitive information disclosure. The appliance must be configured either as a Gateway (VPN virtual server, ICA Proxy, CVPN, RDP Proxy) or an AAA virtual server for exploitation.\n\nSuccessful exploitation could result in the ability to hijack existing authenticated sessions, therefore bypassing multifactor authentication (MFA) or other strong authentication requirements. The sessions may persist after the update to mitigate CVE-2023-4966 has been deployed. Additionally, prior to the update being deployed, Mandiant observed session hijacking where session data was stolen and subsequently used by a threat actor [2].\n\nThe vulnerability `CVE-2023-4967`, with a CVSS score of 8.2 out of 10, can lead to a denial of service attack. The prerequisites for exploitation are the same as the above CVE.\n\n# Remediation\n\nThe Mandiant report [2] about the **CVE-2023-4966** contains the following remediation steps:\n\n1. Isolate NetScaler ADC and Gateway Appliances\n\n    - Isolate the appliances for testing and preparation of patch deployment.\n\n    > Note: If the vulnerable appliances cannot be prioritised for patching, Mandiant recommends that the appliances have ingress IP address restrictions enforced to limit the exposure and attack surface until the necessary patches have been applied.\n\n2. Upgrade Appliances\n    - Upgrade vulnerable NetScaler ADC and Gateway appliances to the latest firmware versions, which mitigate the vulnerability.\n\n3. Terminate Sessions\n    - Post upgrading, terminate all active and persistent sessions (per appliance).\n\n4.  CLI Connection and Command\n    - Connect to the NetScaler appliance using the CLI.\n    - Run the following command (where `<vServer>` is the name of the virtual server / appliance).\n\n        ```\n        kill icaconnection -all\n\n        kill rdp connection -all\n\n        kill pcoipConnection -all\n\n        kill aaa session -all\n\n        clear lb persistentSessions\n        ```\n\n5. Credential Rotation\n    - Due to the lack of available log records or other artefacts of exploitation activity, as a precaution, organisations should consider rotating credentials for identities that were provisioned for accessing resources via a vulnerable NetScaler ADC or Gateway appliance.\n    - If there is evidence of suspicious activity or lateral movement within an environment, organisations should prioritise credential rotation for a larger scope of identities if single factor authentication (SFA) remote access is allowed for any resources from the Internet.\n\n6. Search for Web Shells or Backdoors\n    - If web shells or backdoors are identified on NetScaler appliances, Mandiant recommends rebuilding the appliances using a clean-source image, including the latest firmware.\n\n    > Note: If a restoration of an appliance is required using a backup image, the backup configuration should be reviewed to ensure that there is no evidence of backdoors.\n\n7. Restrict Ingress Access\n    - If possible, reduce the external attack exposure and attack surface of NetScaler appliances by restricting ingress access to only trusted or predefined source IP address ranges.\n\n# Investigation\n\nMandiant has not identified any available logs or other artefacts resident on NetScaler appliances that record evidence of exploitation. Scoping an investigation has consisted of:\n\n– Reviewing NetScaler appliances for evidence of backdoors or web shells.\n\n– Identifying suspicious logon events / lateral movement originating from published systems or resources accessible through the NetScaler appliances.\n\n– Correlating authentication and logon events (e.g., VDI systems published through NetScaler appliances) sourced from geographic locations that are not part of an established baseline.\n\n– Correlating authentication and logon events where a successful MFA challenge response was not logged.\n\nOn October 25, 2023, AssetIO brought more details [3] about the exploitation of **CVE-2023-4966** giving opportunities to detect a possible exploitation of the vulnerability. However, this requires an HTTP frontend source (.e.g network probe, WAF or reverse proxy) before reaching the Citrix HTTP services.\n\nCheck the HTTP logs reaching the URI `/oauth/idp/.well-known/openid-configuration` with a GET method with the status code 200. If hits are found, check if the HTTP response bytes are above `1000000` or if the strings `aaaaaaaaaa` are in the HTTP host header.\n\n**[UPDATE]** Mandiant has used the following approaches [5] to identify potential exploitation of **CVE-2023-4966** and subsequent session hijacking. These include the following techniques [5]:\n\n* Investigating requests to the vulnerable HTTP/S endpoint from WAF: Analysing the incoming requests in the web application firewall logs to identify any unusual or malicious requests targeting the vulnerability, see above.\n\n* Identifying suspicious login patterns based on NetScaler record syslog information in `/var/log/ns.log`:\n    * Suspicious SSLVPN sessions can be identified by comparing the IP addresses recorded in the `Client_ip` and the `Source` fields in `TCPCONNSTAT` events. `TCPCONNSTAT` events record TCP connection-related information for a connection belonging to an SSLVPN session.\n\n    * Identify source IP addresses that access multiple user accounts in a short period of time recorded in the `ns.log` files or forwarded logs via syslog. While a threat actor can choose only to access a single account from a single source IP address, Mandiant has observed that multiple accounts were accessed within hours from the same source IP address by a threat actor.\n\n* Identifying evidence of exploitation using memory analysis of NetScaler Memory Core Dump Files: In some cases, evidence of exploitation can be found in the memory space of the `NSPPE` process of the appliance. Exploitation of CVE-2023-4966 will not crash the `NSPPE` process and generate memory core dump files. To perform analysis of NetScaler memory core dump files, they need to be collected. It is important not to reboot the appliance prior to generating a core dump for analysis.\n\n**[UPDATE]** Following the successful exploitation of **CVE-2023-4966**, Mandiant observed the following TTPs:\n\n- Host and network reconnaissance.\n- Credential harvesting.\n- Lateral movement via RDP.\n- Active Directory reconnaissance using living-off-the-land binaries (e.g., `net.exe`).\n- Internal network enumeration using SoftPerfect network scanner (`netscan.exe`).\n- Compressing reconnaissance results using 7-zip and encoding segments with `certutil`.\n- Loading malicious DLLs into lsass process memory to create a memory dump for offline credential extraction.\n- Deployment of a newly tracked backdoor, `FREEFIRE`, which uses Slack for command and control.\n- Deployment of remote monitoring and management (RMM) tools like Atera, AnyDesk, and SplashTop to maintain a foothold post-exploitation.\n\n# Affected Products\n\n- NetScaler ADC and NetScaler Gateway 14.1 before 14.1-8.50\n- NetScaler ADC and NetScaler Gateway 13.1 before 13.1-49.15\n- NetScaler ADC and NetScaler Gateway 13.0 before 13.0-92.19\n- NetScaler ADC 13.1-FIPS before 13.1-37.164\n- NetScaler ADC 12.1-FIPS before 12.1-55.300\n- NetScaler ADC 12.1-NDcPP before 12.1-55.300\n\nNote: NetScaler ADC and NetScaler Gateway version 12,1 is now End-of-Life (EOL) and is vulnerable [1].\n\n# Recommendations\n\nCERT-EU recommends updating and remediating affected devices as soon as possible. CERT-EU also recommends investigating all affected devices.\n\n# References\n\n[1] <https://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967>\n\n[2] <https://services.google.com/fh/files/misc/citrix-netscaler-adc-gateway-cve-2023-4966-remediation.pdf>\n\n[3] <https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966>\n\n[4] <https://github.com/assetnote/exploits/blob/main/citrix/CVE-2023-4966/exploit.py>\n\n[5] <https://www.mandiant.com/resources/blog/session-hijacking-citrix-cve-2023-4966>",
  "content_html": "<p><em>History:</em></p><ul><li><em>10/10/2023 --- v1.0 -- Initial publication</em></li><li><em>10/10/2023 --- v1.1 -- Fixed affected products list</em></li><li><em>19/10/2023 --- v1.2 -- Added remediation and investigation informations from Mandiant</em></li><li><em>26/10/2023 --- v1.3 -- Added additional remediation commands and detection informations</em></li><li><em>03/11/2023 --- v1.4 -- Added additional detection informations</em></li></ul><h2 id=\"summary\">Summary</h2><p>On October 10, 2023, Citrix issued an advisory about multiple buffer-related vulnerabilities, <strong>CVE-2023-4966</strong> and <strong>CVE-2023-4967</strong>, affecting NetScaler ADC and NetScaler Gateway. These vulnerabilities can result in sensitive information disclosure and denial of service attacks [1].</p><p>It is recommended updating and remediating affected devices <strong>as soon as possible</strong>.</p><p>On October 19, 2023, Mandiant issued a remediation report regarding the vulnerability <strong>CVE-2023-4966</strong> [2]. Mandiant identified a zero-day exploitation of this vulnerability in the wild beginning in late August 2023.</p><p>On October 25, 2023, AssetIO brought more details [3] about the exploitation of <strong>CVE-2023-4966</strong> giving opportunities to detect a possible exploitation of the vulnerability. However, this requires an HTTP frontend source (e.g., network probe, WAF or reverse proxy) before reaching the Citrix HTTP services. A proof-of-concept is also available for that vulnerability [4].</p><p><strong>[UPDATE]</strong> On November 2, 2023, Mandiant shared [5] information about artefacts that can be used to identify exploitation activity. Mandiant also shared their post exploitation techniques observation.</p><h2 id=\"technical-details\">Technical Details</h2><p>The vulnerability <code>CVE-2023-4966</code>, with as CVSS score of 9.4 out of 10, can lead to sensitive information disclosure. The appliance must be configured either as a Gateway (VPN virtual server, ICA Proxy, CVPN, RDP Proxy) or an AAA virtual server for exploitation.</p><p>Successful exploitation could result in the ability to hijack existing authenticated sessions, therefore bypassing multifactor authentication (MFA) or other strong authentication requirements. The sessions may persist after the update to mitigate CVE-2023-4966 has been deployed. Additionally, prior to the update being deployed, Mandiant observed session hijacking where session data was stolen and subsequently used by a threat actor [2].</p><p>The vulnerability <code>CVE-2023-4967</code>, with a CVSS score of 8.2 out of 10, can lead to a denial of service attack. The prerequisites for exploitation are the same as the above CVE.</p><h2 id=\"remediation\">Remediation</h2><p>The Mandiant report [2] about the <strong>CVE-2023-4966</strong> contains the following remediation steps:</p><ol><li><p>Isolate NetScaler ADC and Gateway Appliances</p><ul><li>Isolate the appliances for testing and preparation of patch deployment.</li></ul><blockquote><p>Note: If the vulnerable appliances cannot be prioritised for patching, Mandiant recommends that the appliances have ingress IP address restrictions enforced to limit the exposure and attack surface until the necessary patches have been applied.</p></blockquote></li><li><p>Upgrade Appliances</p><ul><li>Upgrade vulnerable NetScaler ADC and Gateway appliances to the latest firmware versions, which mitigate the vulnerability.</li></ul></li><li><p>Terminate Sessions</p><ul><li>Post upgrading, terminate all active and persistent sessions (per appliance).</li></ul></li><li><p>CLI Connection and Command</p><ul><li>Connect to the NetScaler appliance using the CLI.</li><li>Run the following command (where <code>&lt;vServer&gt;</code> is the name of the virtual server / appliance). <pre><code>kill icaconnection -all\n\nkill rdp connection -all\n\nkill pcoipConnection -all\n\nkill aaa session -all\n\nclear lb persistentSessions\n</code></pre></li></ul></li><li><p>Credential Rotation</p><ul><li>Due to the lack of available log records or other artefacts of exploitation activity, as a precaution, organisations should consider rotating credentials for identities that were provisioned for accessing resources via a vulnerable NetScaler ADC or Gateway appliance.</li><li>If there is evidence of suspicious activity or lateral movement within an environment, organisations should prioritise credential rotation for a larger scope of identities if single factor authentication (SFA) remote access is allowed for any resources from the Internet.</li></ul></li><li><p>Search for Web Shells or Backdoors</p><ul><li>If web shells or backdoors are identified on NetScaler appliances, Mandiant recommends rebuilding the appliances using a clean-source image, including the latest firmware.</li></ul><blockquote><p>Note: If a restoration of an appliance is required using a backup image, the backup configuration should be reviewed to ensure that there is no evidence of backdoors.</p></blockquote></li><li><p>Restrict Ingress Access</p><ul><li>If possible, reduce the external attack exposure and attack surface of NetScaler appliances by restricting ingress access to only trusted or predefined source IP address ranges.</li></ul></li></ol><h2 id=\"investigation\">Investigation</h2><p>Mandiant has not identified any available logs or other artefacts resident on NetScaler appliances that record evidence of exploitation. Scoping an investigation has consisted of:</p><p>– Reviewing NetScaler appliances for evidence of backdoors or web shells.</p><p>– Identifying suspicious logon events / lateral movement originating from published systems or resources accessible through the NetScaler appliances.</p><p>– Correlating authentication and logon events (e.g., VDI systems published through NetScaler appliances) sourced from geographic locations that are not part of an established baseline.</p><p>– Correlating authentication and logon events where a successful MFA challenge response was not logged.</p><p>On October 25, 2023, AssetIO brought more details [3] about the exploitation of <strong>CVE-2023-4966</strong> giving opportunities to detect a possible exploitation of the vulnerability. However, this requires an HTTP frontend source (.e.g network probe, WAF or reverse proxy) before reaching the Citrix HTTP services.</p><p>Check the HTTP logs reaching the URI <code>/oauth/idp/.well-known/openid-configuration</code> with a GET method with the status code 200. If hits are found, check if the HTTP response bytes are above <code>1000000</code> or if the strings <code>aaaaaaaaaa</code> are in the HTTP host header.</p><p><strong>[UPDATE]</strong> Mandiant has used the following approaches [5] to identify potential exploitation of <strong>CVE-2023-4966</strong> and subsequent session hijacking. These include the following techniques [5]:</p><ul><li><p>Investigating requests to the vulnerable HTTP/S endpoint from WAF: Analysing the incoming requests in the web application firewall logs to identify any unusual or malicious requests targeting the vulnerability, see above.</p></li><li><p>Identifying suspicious login patterns based on NetScaler record syslog information in <code>/var/log/ns.log</code>:</p><ul><li><p>Suspicious SSLVPN sessions can be identified by comparing the IP addresses recorded in the <code>Client_ip</code> and the <code>Source</code> fields in <code>TCPCONNSTAT</code> events. <code>TCPCONNSTAT</code> events record TCP connection-related information for a connection belonging to an SSLVPN session.</p></li><li><p>Identify source IP addresses that access multiple user accounts in a short period of time recorded in the <code>ns.log</code> files or forwarded logs via syslog. While a threat actor can choose only to access a single account from a single source IP address, Mandiant has observed that multiple accounts were accessed within hours from the same source IP address by a threat actor.</p></li></ul></li><li><p>Identifying evidence of exploitation using memory analysis of NetScaler Memory Core Dump Files: In some cases, evidence of exploitation can be found in the memory space of the <code>NSPPE</code> process of the appliance. Exploitation of CVE-2023-4966 will not crash the <code>NSPPE</code> process and generate memory core dump files. To perform analysis of NetScaler memory core dump files, they need to be collected. It is important not to reboot the appliance prior to generating a core dump for analysis.</p></li></ul><p><strong>[UPDATE]</strong> Following the successful exploitation of <strong>CVE-2023-4966</strong>, Mandiant observed the following TTPs:</p><ul><li>Host and network reconnaissance.</li><li>Credential harvesting.</li><li>Lateral movement via RDP.</li><li>Active Directory reconnaissance using living-off-the-land binaries (e.g., <code>net.exe</code>).</li><li>Internal network enumeration using SoftPerfect network scanner (<code>netscan.exe</code>).</li><li>Compressing reconnaissance results using 7-zip and encoding segments with <code>certutil</code>.</li><li>Loading malicious DLLs into lsass process memory to create a memory dump for offline credential extraction.</li><li>Deployment of a newly tracked backdoor, <code>FREEFIRE</code>, which uses Slack for command and control.</li><li>Deployment of remote monitoring and management (RMM) tools like Atera, AnyDesk, and SplashTop to maintain a foothold post-exploitation.</li></ul><h2 id=\"affected-products\">Affected Products</h2><ul><li>NetScaler ADC and NetScaler Gateway 14.1 before 14.1-8.50</li><li>NetScaler ADC and NetScaler Gateway 13.1 before 13.1-49.15</li><li>NetScaler ADC and NetScaler Gateway 13.0 before 13.0-92.19</li><li>NetScaler ADC 13.1-FIPS before 13.1-37.164</li><li>NetScaler ADC 12.1-FIPS before 12.1-55.300</li><li>NetScaler ADC 12.1-NDcPP before 12.1-55.300</li></ul><p>Note: NetScaler ADC and NetScaler Gateway version 12,1 is now End-of-Life (EOL) and is vulnerable [1].</p><h2 id=\"recommendations\">Recommendations</h2><p>CERT-EU recommends updating and remediating affected devices as soon as possible. CERT-EU also recommends investigating all affected devices.</p><h2 id=\"references\">References</h2><p>[1] <a rel=\"noopener\" target=\"_blank\" href=\"https://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967\">https://support.citrix.com/article/CTX579459/netscaler-adc-and-netscaler-gateway-security-bulletin-for-cve20234966-and-cve20234967</a></p><p>[2] <a rel=\"noopener\" target=\"_blank\" href=\"https://services.google.com/fh/files/misc/citrix-netscaler-adc-gateway-cve-2023-4966-remediation.pdf\">https://services.google.com/fh/files/misc/citrix-netscaler-adc-gateway-cve-2023-4966-remediation.pdf</a></p><p>[3] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966\">https://www.assetnote.io/resources/research/citrix-bleed-leaking-session-tokens-with-cve-2023-4966</a></p><p>[4] <a rel=\"noopener\" target=\"_blank\" href=\"https://github.com/assetnote/exploits/blob/main/citrix/CVE-2023-4966/exploit.py\">https://github.com/assetnote/exploits/blob/main/citrix/CVE-2023-4966/exploit.py</a></p><p>[5] <a rel=\"noopener\" target=\"_blank\" href=\"https://www.mandiant.com/resources/blog/session-hijacking-citrix-cve-2023-4966\">https://www.mandiant.com/resources/blog/session-hijacking-citrix-cve-2023-4966</a></p>",
  "licence": {
    "title": "Creative Commons Attribution 4.0 International (CC-BY 4.0)",
    "link": "https://creativecommons.org/licenses/by/4.0/",
    "restrictions": "https://cert.europa.eu/legal-notice",
    "author": "The Cybersecurity Service for the Union institutions, bodies, offices and agencies"
  },
  "cves": [
    "CVE-2023-4966",
    "CVE-2023-4967"
  ]
}